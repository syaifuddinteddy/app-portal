/*! JointJS v0.9.3 - JavaScript diagramming library  2015-05-22 


 This Source Code Form is subject to the terms of the Mozilla Public
 License, v. 2.0. If a copy of the MPL was not distributed with this
 file, You can obtain one at http://mozilla.org/MPL/2.0/.
 */
;var joint={version:"0.9.3",dia:{},ui:{},layout:{},shapes:{},format:{},connectors:{},routers:{},util:{hashCode:function(f){var e=0;if(0==f.length){return e}for(var i=0;i<f.length;i++){var h=f.charCodeAt(i);e=(e<<5)-e+h,e&=e}return e},getByPath:function(h,f,k){k=k||".";for(var j,i=f.split(k);i.length;){if(j=i.shift(),!(Object(h)===h&&j in h)){return void 0}h=h[j]}return h},setByPath:function(j,i,p,o){o=o||".";var n=i.split(o),m=j,l=0;if(i.indexOf(o)>-1){for(var k=n.length;k-1>l;l++){m=m[n[l]]||(m[n[l]]={})}m[n[k-1]]=p}else{j[i]=p}return j},unsetByPath:function(h,f,k){k=k||".";var j=f.lastIndexOf(k);if(j>-1){var i=joint.util.getByPath(h,f.substr(0,j),k);i&&delete i[f.slice(j+1)]}else{delete h[f]}return h},flattenObject:function(j,i,p){i=i||".";var o={};for(var n in j){if(j.hasOwnProperty(n)){var m="object"==typeof j[n];if(m&&p&&p(j[n])&&(m=!1),m){var l=this.flattenObject(j[n],i,p);for(var k in l){l.hasOwnProperty(k)&&(o[n+i+k]=l[k])}}else{o[n]=j[n]}}}return o},uuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var d=16*Math.random()|0,f="x"==e?d:3&d|8;return f.toString(16)})},guid:function(b){return this.guid.id=this.guid.id||1,b.id=void 0===b.id?"j_"+this.guid.id++:b.id,b.id},mixin:function(){for(var f=arguments[0],e=1,i=arguments.length;i>e;e++){var h=arguments[e];(Object(h)===h||_.isFunction(h)||null!==h&&void 0!==h)&&_.each(h,function(a,d){return this.mixin.deep&&Object(a)===a?(f[d]||(f[d]=_.isArray(a)?[]:{}),void this.mixin(f[d],a)):void (f[d]!==a&&(this.mixin.supplement&&f.hasOwnProperty(d)||(f[d]=a)))},this)}return f},supplement:function(){this.mixin.supplement=!0;var b=this.mixin.apply(this,arguments);return this.mixin.supplement=!1,b},deepMixin:function(){this.mixin.deep=!0;var b=this.mixin.apply(this,arguments);return this.mixin.deep=!1,b},deepSupplement:function(){this.mixin.deep=this.mixin.supplement=!0;var b=this.mixin.apply(this,arguments);return this.mixin.deep=this.mixin.supplement=!1,b},normalizeEvent:function(b){return b.originalEvent&&b.originalEvent.changedTouches&&b.originalEvent.changedTouches.length?b.originalEvent.changedTouches[0]:b},nextFrame:function(){var e,d="undefined"!=typeof window;if(d&&(e=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame),!e){var f=0;e=function(h){var c=(new Date).getTime(),j=Math.max(0,16-(c-f)),i=setTimeout(function(){h(c+j)},j);return f=c+j,i}}return d?_.bind(e,window):e}(),cancelFrame:function(){var d,c="undefined"!=typeof window;return c&&(d=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.msCancelRequestAnimationFrame||window.oCancelAnimationFrame||window.oCancelRequestAnimationFrame||window.mozCancelAnimationFrame||window.mozCancelRequestAnimationFrame),d=d||clearTimeout,c?_.bind(d,window):d}(),shapePerimeterConnectionPoint:function(k,j,q,p){var o,n;if(!q){var m=j.$(".scalable")[0],l=j.$(".rotatable")[0];m&&m.firstChild?q=m.firstChild:l&&l.firstChild&&(q=l.firstChild)}return q?(n=V(q).findIntersection(p,k.paper.viewport),n||(o=g.rect(V(q).bbox(!1,k.paper.viewport)))):(o=j.model.getBBox(),n=o.intersectionWithLineFromCenterToPoint(p)),n||o.center()},breakText:function(N,M,L,K){K=K||{};var J=M.width,I=M.height,H=K.svgDocument||V("svg").node,G=V("<text><tspan></tspan></text>").attr(L||{}).node,F=G.firstChild,E=document.createTextNode("");F.appendChild(E),H.appendChild(G),K.svgDocument||document.body.appendChild(H);for(var D,C=N.split(" "),B=[],A=[],z=0,y=0,x=C.length;x>z;z++){var w=C[z];if(E.data=A[y]?A[y]+" "+w:w,F.getComputedTextLength()<=J){A[y]=E.data,D&&(B[y++]=!0,D=0)}else{if(!A[y]||D){var v=!!D;if(D=w.length-1,v||!D){if(!D){if(!A[y]){A=[];break}C.splice(z,2,w+C[z+1]),x--,B[y++]=!0,z--;continue}C[z]=w.substring(0,D),C[z+1]=w.substring(D)+C[z+1]}else{C.splice(z,1,w.substring(0,D),w.substring(D)),x++,y&&!B[y-1]&&y--}z--;continue}y++,z--}if("undefined"!=typeof I){var u=u||1.25*G.getBBox().height;if(u*A.length>I){A.splice(Math.floor(I/u));break}}}return K.svgDocument?H.removeChild(G):document.body.removeChild(H),A.join("\n")},imageToDataUri:function(f,e){if(!f||"data:"===f.substr(0,"data:".length)){return setTimeout(function(){e(null,f)},0)}var i=document.createElement("canvas"),h=document.createElement("img");h.onload=function(){var l=i.getContext("2d");i.width=h.width,i.height=h.height,l.drawImage(h,0,0);try{var k=(f.split(".").pop()||"png","jpeg"),d=i.toDataURL(k)}catch(c){if(/\.svg$/.test(f)){var b=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");b.open("GET",f,!1),b.send(null);var a=b.responseText;return e(null,"data:image/svg+xml,"+encodeURIComponent(a))}console.error(h.src,"fails to convert",c)}e(null,d)},h.ononerror=function(){e(new Error("Failed to load image."))},h.src=f},timing:{linear:function(b){return b},quad:function(b){return b*b},cubic:function(b){return b*b*b},inout:function(e){if(0>=e){return 0}if(e>=1){return 1}var d=e*e,f=d*e;return 4*(0.5>e?f:3*(e-d)+f-0.75)},exponential:function(b){return Math.pow(2,10*(b-1))},bounce:function(f){for(var e=0,i=1;1;e+=i,i/=2){if(f>=(7-4*e)/11){var h=(11-6*e-11*f)/4;return -h*h+i*i}}},reverse:function(b){return function(a){return 1-b(1-a)}},reflect:function(b){return function(a){return 0.5*(0.5>a?b(2*a):2-b(2-2*a))}},clamp:function(e,d,f){return d=d||0,f=f||1,function(b){var a=e(b);return d>a?d:a>f?f:a}},back:function(b){return b||(b=1.70158),function(a){return a*a*((b+1)*a-b)}},elastic:function(b){return b||(b=1.5),function(a){return Math.pow(2,10*(a-1))*Math.cos(20*Math.PI*b/3*a)}}},interpolate:{number:function(e,d){var f=d-e;return function(a){return e+f*a}},object:function(e,d){var f=_.keys(e);return function(h){var c,b,a={};for(c=f.length-1;-1!=c;c--){b=f[c],a[b]=e[b]+(d[b]-e[b])*h}return a}},hexColor:function(t,s){var r=parseInt(t.slice(1),16),q=parseInt(s.slice(1),16),p=255&r,o=(255&q)-p,n=65280&r,m=(65280&q)-n,l=16711680&r,k=(16711680&q)-l;return function(f){var e=p+o*f&255,i=n+m*f&65280,h=l+k*f&16711680;return"#"+(1<<24|e|i|h).toString(16).slice(1)}},unit:function(r,q){var p=/(-?[0-9]*.[0-9]*)(px|em|cm|mm|in|pt|pc|%)/,o=p.exec(r),n=p.exec(q),m=n[1].indexOf("."),l=m>0?n[1].length-m-1:0;r=+o[1];var k=+n[1]-r,j=o[2];return function(a){return(r+k*a).toFixed(l)+j}}},filter:{blur:function(d){var c=_.isFinite(d.x)?d.x:2;return _.template('<filter><feGaussianBlur stdDeviation="${stdDeviation}"/></filter>',{stdDeviation:_.isFinite(d.y)?[c,d.y]:c})},dropShadow:function(d){var c="SVGFEDropShadowElement" in window?'<filter><feDropShadow stdDeviation="${blur}" dx="${dx}" dy="${dy}" flood-color="${color}" flood-opacity="${opacity}"/></filter>':'<filter><feGaussianBlur in="SourceAlpha" stdDeviation="${blur}"/><feOffset dx="${dx}" dy="${dy}" result="offsetblur"/><feFlood flood-color="${color}"/><feComposite in2="offsetblur" operator="in"/><feComponentTransfer><feFuncA type="linear" slope="${opacity}"/></feComponentTransfer><feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge></filter>';return _.template(c,{dx:d.dx||0,dy:d.dy||0,opacity:_.isFinite(d.opacity)?d.opacity:1,color:d.color||"black",blur:_.isFinite(d.blur)?d.blur:4})},grayscale:function(d){var c=_.isFinite(d.amount)?d.amount:1;return _.template('<filter><feColorMatrix type="matrix" values="${a} ${b} ${c} 0 0 ${d} ${e} ${f} 0 0 ${g} ${b} ${h} 0 0 0 0 0 1 0"/></filter>',{a:0.2126+0.7874*(1-c),b:0.7152-0.7152*(1-c),c:0.0722-0.0722*(1-c),d:0.2126-0.2126*(1-c),e:0.7152+0.2848*(1-c),f:0.0722-0.0722*(1-c),g:0.2126-0.2126*(1-c),h:0.0722+0.9278*(1-c)})},sepia:function(d){var c=_.isFinite(d.amount)?d.amount:1;return _.template('<filter><feColorMatrix type="matrix" values="${a} ${b} ${c} 0 0 ${d} ${e} ${f} 0 0 ${g} ${h} ${i} 0 0 0 0 0 1 0"/></filter>',{a:0.393+0.607*(1-c),b:0.769-0.769*(1-c),c:0.189-0.189*(1-c),d:0.349-0.349*(1-c),e:0.686+0.314*(1-c),f:0.168-0.168*(1-c),g:0.272-0.272*(1-c),h:0.534-0.534*(1-c),i:0.131+0.869*(1-c)})},saturate:function(d){var c=_.isFinite(d.amount)?d.amount:1;return _.template('<filter><feColorMatrix type="saturate" values="${amount}"/></filter>',{amount:1-c})},hueRotate:function(b){return _.template('<filter><feColorMatrix type="hueRotate" values="${angle}"/></filter>',{angle:b.angle||0})},invert:function(d){var c=_.isFinite(d.amount)?d.amount:1;return _.template('<filter><feComponentTransfer><feFuncR type="table" tableValues="${amount} ${amount2}"/><feFuncG type="table" tableValues="${amount} ${amount2}"/><feFuncB type="table" tableValues="${amount} ${amount2}"/></feComponentTransfer></filter>',{amount:c,amount2:1-c})},brightness:function(b){return _.template('<filter><feComponentTransfer><feFuncR type="linear" slope="${amount}"/><feFuncG type="linear" slope="${amount}"/><feFuncB type="linear" slope="${amount}"/></feComponentTransfer></filter>',{amount:_.isFinite(b.amount)?b.amount:1})},contrast:function(d){var c=_.isFinite(d.amount)?d.amount:1;return _.template('<filter><feComponentTransfer><feFuncR type="linear" slope="${amount}" intercept="${amount2}"/><feFuncG type="linear" slope="${amount}" intercept="${amount2}"/><feFuncB type="linear" slope="${amount}" intercept="${amount2}"/></feComponentTransfer></filter>',{amount:c,amount2:0.5-c/2})}},format:{number:function(ae,ad,ac){function ab(h){for(var c=h.length,k=[],j=0,i=ac.grouping[0];c>0&&i>0;){k.push(h.substring(c-=i,c+i)),i=ac.grouping[j=(j+1)%ac.grouping.length]}return k.reverse().join(ac.thousands)}ac=ac||{currency:["$",""],decimal:".",thousands:",",grouping:[3]};var aa=/(?:([^{])?([<>=^]))?([+\- ])?([$#])?(0)?(\d+)?(,)?(\.-?\d+)?([a-z%])?/i,Z=aa.exec(ae),Y=Z[1]||" ",X=Z[2]||">",W=Z[3]||"",U=Z[4]||"",T=Z[5],S=+Z[6],R=Z[7],Q=Z[8],P=Z[9],O=1,M="",K="",J=!1;switch(Q&&(Q=+Q.substring(1)),(T||"0"===Y&&"="===X)&&(T=Y="0",X="=",R&&(S-=Math.floor((S-1)/4))),P){case"n":R=!0,P="g";break;case"%":O=100,K="%",P="f";break;case"p":O=100,K="%",P="r";break;case"b":case"o":case"x":case"X":"#"===U&&(M="0"+P.toLowerCase());case"c":case"d":J=!0,Q=0;break;case"s":O=-1,P="r"}"$"===U&&(M=ac.currency[0],K=ac.currency[1]),"r"!=P||Q||(P="g"),null!=Q&&("g"==P?Q=Math.max(1,Math.min(21,Q)):("e"==P||"f"==P)&&(Q=Math.max(0,Math.min(20,Q))));var I=T&&R;if(J&&ad%1){return""}var H=0>ad||0===ad&&0>1/ad?(ad=-ad,"-"):W,G=K;if(0>O){var F=this.prefix(ad,Q);ad=F.scale(ad),G=F.symbol+K}else{ad*=O}ad=this.convert(P,ad,Q);var E=ad.lastIndexOf("."),D=0>E?ad:ad.substring(0,E),C=0>E?"":ac.decimal+ad.substring(E+1);!T&&R&&ac.grouping&&(D=ab(D));var N=M.length+D.length+C.length+(I?0:H.length),L=S>N?new Array(N=S-N+1).join(Y):"";return I&&(D=ab(L+D)),H+=M,ad=D+C,("<"===X?H+ad+L:">"===X?L+H+ad:"^"===X?L.substring(0,N>>=1)+H+ad+L.substring(N):H+(I?ad:L+ad))+G},string:function(t,s){for(var r,q="{",p=!1,o=[];-1!==(r=t.indexOf(q));){var n,m,l;if(n=t.slice(0,r),p){m=n.split(":"),l=m.shift().split("."),n=s;for(var k=0;k<l.length;k++){n=n[l[k]]}m.length&&(n=this.number(m,n))}o.push(n),t=t.slice(r+1),q=(p=!p)?"}":"{"}return o.push(t),o.join("")},convert:function(e,d,f){switch(e){case"b":return d.toString(2);case"c":return String.fromCharCode(d);case"o":return d.toString(8);case"x":return d.toString(16);case"X":return d.toString(16).toUpperCase();case"g":return d.toPrecision(f);case"e":return d.toExponential(f);case"f":return d.toFixed(f);case"r":return(d=this.round(d,this.precision(d,f))).toFixed(Math.max(0,Math.min(20,this.precision(d*(1+1e-15),f))));default:return d+""}},round:function(d,c){return c?Math.round(d*(c=Math.pow(10,c)))/c:Math.round(d)},precision:function(d,c){return c-(d?Math.ceil(Math.log(d)/Math.LN10):1)},prefix:function(f,e){var i=_.map(["y","z","a","f","p","n","µ","m","","k","M","G","T","P","E","Z","Y"],function(j,d){var k=Math.pow(10,3*abs(8-d));return{scale:d>8?function(b){return b/k}:function(b){return b*k},symbol:j}}),h=0;return f&&(0>f&&(f*=-1),e&&(f=this.round(f,this.precision(f,e))),h=1+Math.floor(1e-12+Math.log(f)/Math.LN10),h=Math.max(-24,Math.min(24,3*Math.floor((0>=h?h+1:h-1)/3)))),i[8+h/3]}}}};joint.dia.GraphCells=Backbone.Collection.extend({initialize:function(){this.on("change:z",this.sort,this)},model:function(f,e){if("link"===f.type){return new joint.dia.Link(f,e)}var i=f.type.split(".")[0],h=f.type.split(".")[1];return joint.shapes[i]&&joint.shapes[i][h]?new joint.shapes[i][h](f,e):new joint.dia.Element(f,e)},comparator:function(b){return b.get("z")||0},getConnectedLinks:function(f,e){e=e||{},_.isUndefined(e.inbound)&&_.isUndefined(e.outbound)&&(e.inbound=e.outbound=!0);var i=this.filter(function(j){var b=j.get("source"),a=j.get("target");return b&&b.id===f.id&&e.outbound||a&&a.id===f.id&&e.inbound});if(e.deep){var h=f.getEmbeddedCells({deep:!0});_.each(this.difference(i,h),function(b){if(e.outbound){var d=b.get("source");if(d&&d.id&&_.find(h,{id:d.id})){return void i.push(b)}}if(e.inbound){var c=b.get("target");c&&c.id&&_.find(h,{id:c.id})&&i.push(b)}})}return i},getCommonAncestor:function(){var d=_.map(arguments,function(f){for(var e=[f.id],h=f.get("parent");h;){e.push(h),h=this.get(h).get("parent")}return e},this);d=_.sortBy(d,"length");var c=_.find(d.shift(),function(a){return _.every(d,function(b){return _.contains(b,a)})});return this.get(c)},getBBox:function(e){e=e||this.models;var d={x:1/0,y:1/0},f={x:-(1/0),y:-(1/0)};return _.each(e,function(b){if(!b.isLink()){var c=b.getBBox();d.x=Math.min(d.x,c.x),d.y=Math.min(d.y,c.y),f.x=Math.max(f.x,c.x+c.width),f.y=Math.max(f.y,c.y+c.height)}}),g.rect(d.x,d.y,f.x-d.x,f.y-d.y)}}),joint.dia.Graph=Backbone.Model.extend({initialize:function(d,c){this.set("cells",new joint.dia.GraphCells([],{model:c&&c.cellModel})),this.get("cells").on("all",this.trigger,this),this.get("cells").on("remove",this.removeCell,this)},toJSON:function(){var b=Backbone.Model.prototype.toJSON.apply(this,arguments);return b.cells=this.get("cells").toJSON(),b},fromJSON:function(d,c){if(!d.cells){throw new Error("Graph JSON must contain cells array.")}this.set(_.omit(d,"cells"),c),this.resetCells(d.cells,c)},clear:function(b){this.trigger("batch:start"),this.get("cells").remove(this.get("cells").models,b),this.trigger("batch:stop")},_prepareCell:function(b){return b instanceof Backbone.Model&&_.isUndefined(b.get("z"))?b.set("z",this.maxZIndex()+1,{silent:!0}):_.isUndefined(b.z)&&(b.z=this.maxZIndex()+1),b},maxZIndex:function(){var b=this.get("cells").last();return b?b.get("z")||0:0},addCell:function(d,c){return _.isArray(d)?this.addCells(d,c):(this.get("cells").add(this._prepareCell(d),c||{}),this)},addCells:function(d,c){return c=c||{},c.position=d.length,_.each(d,function(b){c.position--,this.addCell(b,c)},this),this},resetCells:function(d,c){return this.get("cells").reset(_.map(d,this._prepareCell,this),c),this},removeCell:function(e,d,f){f&&f.disconnectLinks?this.disconnectLinks(e,f):this.removeLinks(e,f),this.get("cells").remove(e,{silent:!0})},getCell:function(b){return this.get("cells").get(b)},getElements:function(){return this.get("cells").filter(function(b){return b instanceof joint.dia.Element})},getLinks:function(){return this.get("cells").filter(function(b){return b instanceof joint.dia.Link})},getConnectedLinks:function(d,c){return this.get("cells").getConnectedLinks(d,c)},getNeighbors:function(f){var e=this.getConnectedLinks(f),i=[],h=this.get("cells");return _.each(e,function(a){var k=a.get("source"),j=a.get("target");if(!k.x){var d=h.get(k.id);d!==f&&i.push(d)}if(!j.x){var c=h.get(j.id);c!==f&&i.push(c)}}),i},disconnectLinks:function(d,c){_.each(this.getConnectedLinks(d),function(a){a.set(a.get("source").id===d.id?"source":"target",g.point(0,0),c)})},removeLinks:function(d,c){_.invoke(this.getConnectedLinks(d),"remove",c)},findModelsFromPoint:function(b){return _.filter(this.getElements(),function(a){return a.getBBox().containsPoint(b)})},findModelsInArea:function(b){return _.filter(this.getElements(),function(a){return a.getBBox().intersect(b)})},getBBox:function(){var b=this.get("cells");return b.getBBox.apply(b,arguments)},getCommonAncestor:function(){var b=this.get("cells");return b.getCommonAncestor.apply(b,arguments)}}),joint.dia.Cell=Backbone.Model.extend({constructor:function(f,e){var i,h=f||{};this.cid=_.uniqueId("c"),this.attributes={},e&&e.collection&&(this.collection=e.collection),e&&e.parse&&(h=this.parse(h,e)||{}),(i=_.result(this,"defaults"))&&(h=_.merge({},i,h)),this.set(h,e),this.changed={},this.initialize.apply(this,arguments)},toJSON:function(){var f=this.constructor.prototype.defaults.attrs||{},e=this.attributes.attrs,i={};_.each(e,function(a,j){var c=f[j];_.each(a,function(k,d){_.isObject(k)&&!_.isArray(k)?_.each(k,function(b,l){c&&c[d]&&_.isEqual(c[d][l],b)||(i[j]=i[j]||{},(i[j][d]||(i[j][d]={}))[l]=b)}):c&&_.isEqual(c[d],k)||(i[j]=i[j]||{},i[j][d]=k)})});var h=_.cloneDeep(_.omit(this.attributes,"attrs"));return h.attrs=i,h},initialize:function(b){b&&b.id||this.set("id",joint.util.uuid(),{silent:!0}),this._transitionIds={},this.processPorts(),this.on("change:attrs",this.processPorts,this)},processPorts:function(){var h=this.ports,f={};_.each(this.get("attrs"),function(b,d){b&&b.port&&(_.isUndefined(b.port.id)?f[b.port]={id:b.port}:f[b.port.id]=b.port)});var k={};if(_.each(h,function(b,c){f[c]||(k[c]=!0)}),this.collection&&!_.isEmpty(k)){var j=this.collection.getConnectedLinks(this,{inbound:!0});_.each(j,function(b){k[b.get("target").port]&&b.remove()});var i=this.collection.getConnectedLinks(this,{outbound:!0});_.each(i,function(b){k[b.get("source").port]&&b.remove()})}this.ports=f},remove:function(f){f=f||{};var e=this.collection;e&&e.trigger("batch:start",{batchName:"remove"});var i=this.get("parent");if(i){var h=this.collection&&this.collection.get(i);h.unembed(this)}return _.invoke(this.getEmbeddedCells(),"remove",f),this.trigger("remove",this,this.collection,f),e&&e.trigger("batch:stop",{batchName:"remove"}),this},toFront:function(e){if(this.collection){e=e||{};var d=(this.collection.last().get("z")||0)+1;if(this.trigger("batch:start",{batchName:"to-front"}).set("z",d,e),e.deep){var f=this.getEmbeddedCells({deep:!0,breadthFirst:!0});_.each(f,function(a){a.set("z",++d,e)})}this.trigger("batch:stop",{batchName:"to-front"})}return this},toBack:function(e){if(this.collection){e=e||{};var d=(this.collection.first().get("z")||0)-1;if(this.trigger("batch:start",{batchName:"to-back"}),e.deep){var f=this.getEmbeddedCells({deep:!0,breadthFirst:!0});_.eachRight(f,function(a){a.set("z",d--,e)})}this.set("z",d,e).trigger("batch:stop",{batchName:"to-back"})}return this},embed:function(e,d){if(this==e||this.isEmbeddedIn(e)){throw new Error("Recursive embedding not allowed.")}this.trigger("batch:start",{batchName:"embed"});var f=_.clone(this.get("embeds")||[]);return f[e.isLink()?"unshift":"push"](e.id),e.set("parent",this.id,d),this.set("embeds",_.uniq(f),d),this.trigger("batch:stop",{batchName:"embed"}),this},unembed:function(d,c){return this.trigger("batch:start",{batchName:"unembed"}),d.unset("parent",c),this.set("embeds",_.without(this.get("embeds"),d.id),c),this.trigger("batch:stop",{batchName:"unembed"}),this},getAncestors:function(){var e=[],d=this.get("parent");if(void 0===this.collection){return e}for(;void 0!==d;){var f=this.collection.get(d);if(void 0===f){break}e.push(f),d=f.get("parent")}return e},getEmbeddedCells:function(f){if(f=f||{},this.collection){var e;if(f.deep){if(f.breadthFirst){e=[];for(var i=this.getEmbeddedCells();i.length>0;){var h=i.shift();e.push(h),i.push.apply(i,h.getEmbeddedCells())}}else{e=this.getEmbeddedCells(),_.each(e,function(a){e.push.apply(e,a.getEmbeddedCells(f))})}}else{e=_.map(this.get("embeds"),this.collection.get,this.collection)}return e}return[]},isEmbeddedIn:function(f,e){var i=_.isString(f)?f:f.id,h=this.get("parent");if(e=_.defaults({deep:!0},e),this.collection&&e.deep){for(;h;){if(h==i){return !0}h=this.collection.get(h).get("parent")}return !1}return h==i},clone:function(h){h=h||{};var f=Backbone.Model.prototype.clone.apply(this,arguments);if(f.set("id",joint.util.uuid(),{silent:!0}),f.set("embeds",""),!h.deep){return f}var k=_.sortBy(this.getEmbeddedCells(),function(b){return b instanceof joint.dia.Element}),j=[f],i={};return _.each(k,function(b){var d=b.clone({deep:!0});f.embed(d[0]),_.each(d,function(l){if(l instanceof joint.dia.Link){return l.get("source").id==this.id&&l.prop("source",{id:f.id}),l.get("target").id==this.id&&l.prop("target",{id:f.id}),void (i[b.id]=l)}j.push(l);var e=this.collection.getConnectedLinks(b,{inbound:!0});_.each(e,function(m){var c=i[m.id]||m.clone();i[m.id]=c,c.prop("target",{id:l.id})});var a=this.collection.getConnectedLinks(b,{outbound:!0});_.each(a,function(m){var c=i[m.id]||m.clone();i[m.id]=c,c.prop("source",{id:l.id})})},this)},this),j=j.concat(_.values(i))},prop:function(x,w,v){var u="/";if(_.isString(x)){if(arguments.length>1){var t=x,s=t.split("/"),r=s[0];if(v=v||{},v.propertyPath=t,v.propertyValue=w,1==s.length){return this.set(r,w,v)}var q={},p=q,o=r;_.each(_.rest(s),function(b){p=p[o]=_.isFinite(Number(b))?[]:{},o=b}),q=joint.util.setByPath(q,t,w,"/");var n=_.merge({},this.attributes);v.rewrite&&joint.util.unsetByPath(n,t,"/");var m=_.merge(n,q);return this.set(r,m[r],v)}return joint.util.getByPath(this.attributes,x,u)}return this.set(_.merge({},this.attributes,x),w)},removeProp:function(i,h){h=h||{},h.dirty=!0;var m=i.split("/");if(1===m.length){return this.unset(i,h)}var l=m[0],k=m.slice(1).join("/"),j=_.merge({},this.get(l));return joint.util.unsetByPath(j,k,"/"),this.set(l,j,h)},attr:function(f,e,i){var h=Array.prototype.slice.call(arguments);return h[0]=_.isString(f)?"attrs/"+f:{attrs:f},this.prop.apply(this,h)},removeAttr:function(d,c){return _.isArray(d)?(_.each(d,function(b){this.removeAttr(b,c)},this),this):this.removeProp("attrs/"+d,c)},transition:function(r,q,p,o){o=o||"/";var n={duration:100,delay:10,timingFunction:joint.util.timing.linear,valueFunction:joint.util.interpolate.number};p=_.extend(n,p);var m,l=0,k=_.bind(function(a){var h,f,c;l=l||a,a-=l,f=a/p.duration,1>f?this._transitionIds[r]=h=joint.util.nextFrame(k):(f=1,delete this._transitionIds[r]),c=m(p.timingFunction(f)),p.transitionId=h,this.prop(r,c,p),h||this.trigger("transition:end",this,r)},this),j=_.bind(function(a){this.stopTransitions(r),m=p.valueFunction(joint.util.getByPath(this.attributes,r,o),q),this._transitionIds[r]=joint.util.nextFrame(a),this.trigger("transition:start",this,r)},this);return _.delay(j,p.delay,k)},getTransitions:function(){return _.keys(this._transitionIds)},stopTransitions:function(e,d){d=d||"/";var f=e&&e.split(d);return _(this._transitionIds).keys().filter(f&&function(b){return _.isEqual(f,b.split(d).slice(0,f.length))}).each(function(b){joint.util.cancelFrame(this._transitionIds[b]),delete this._transitionIds[b],this.trigger("transition:end",this,b)},this),this},addTo:function(d,c){return d.addCell(this,c),this},findView:function(b){return b.findViewByModel(this)},isLink:function(){return !1}}),joint.dia.CellView=Backbone.View.extend({tagName:"g",attributes:function(){return{"model-id":this.model.id}},constructor:function(b){this._configure(b),Backbone.View.apply(this,arguments)},_configure:function(b){this.options&&(b=_.extend({},_.result(this,"options"),b)),this.options=b,this.options.id=this.options.id||joint.util.guid(this)},initialize:function(){_.bindAll(this,"remove","update"),this.$el.data("view",this),this.listenTo(this.model,"remove",this.remove),this.listenTo(this.model,"change:attrs",this.onChangeAttrs)},onChangeAttrs:function(e,d,f){return f.dirty?this.render():this.update()},_ensureElement:function(){var d;if(this.el){d=_.result(this,"el")}else{var c=_.extend({id:this.id},_.result(this,"attributes"));this.className&&(c["class"]=_.result(this,"className")),d=V(_.result(this,"tagName"),c).node}this.setElement(d,!1)},findBySelector:function(d){var c="."===d?this.$el:this.$el.find(d);return c},notify:function(d){if(this.paper){var c=Array.prototype.slice.call(arguments,1);this.trigger.apply(this,[d].concat(c)),this.paper.trigger.apply(this.paper,[d,this].concat(c))}},getStrokeBBox:function(f){var e=!!f;f=f||this.el;var i,h=V(f).bbox(!1,this.paper.viewport);return i=e?V(f).attr("stroke-width"):this.model.attr("rect/stroke-width")||this.model.attr("circle/stroke-width")||this.model.attr("ellipse/stroke-width")||this.model.attr("path/stroke-width"),i=parseFloat(i)||0,g.rect(h).moveAndExpand({x:-i/2,y:-i/2,width:i,height:i})},getBBox:function(){return V(this.el).bbox()},highlight:function(d,c){return d=d?this.$(d)[0]||this.el:this.el,c=c||{},c.partial=d!=this.el,this.notify("cell:highlight",d,c),this},unhighlight:function(d,c){return d=d?this.$(d)[0]||this.el:this.el,c=c||{},c.partial=d!=this.el,this.notify("cell:unhighlight",d,c),this},findMagnet:function(e){var d=this.$(e);if(0===d.length||d[0]===this.el){var f=this.model.get("attrs")||{};return f["."]&&f["."].magnet===!1?void 0:this.el}return d.attr("magnet")?d[0]:this.findMagnet(d.parent())},applyFilter:function(i,h){var m=this.findBySelector(i),l=h.name+this.paper.svg.id+joint.util.hashCode(JSON.stringify(h));if(!this.paper.svg.getElementById(l)){var k=joint.util.filter[h.name]&&joint.util.filter[h.name](h.args||{});if(!k){throw new Error("Non-existing filter "+h.name)}var j=V(k);j.attr({filterUnits:"objectBoundingBox",x:-1,y:-1,width:3,height:3}),h.attrs&&j.attr(h.attrs),j.node.id=l,V(this.paper.svg).defs().append(j)}m.each(function(){V(this).attr("filter","url(#"+l+")")})},applyGradient:function(i,h,n){var m=this.findBySelector(i),l=n.type+this.paper.svg.id+joint.util.hashCode(JSON.stringify(n));if(!this.paper.svg.getElementById(l)){var k=["<"+n.type+">",_.map(n.stops,function(b){return'<stop offset="'+b.offset+'" stop-color="'+b.color+'" stop-opacity="'+(_.isFinite(b.opacity)?b.opacity:1)+'" />'}).join(""),"</"+n.type+">"].join(""),j=V(k);n.attrs&&j.attr(n.attrs),j.node.id=l,V(this.paper.svg).defs().append(j)}m.each(function(){V(this).attr(h,"url(#"+l+")")})},getSelector:function(f,e){if(f===this.el){return e}var i=V(f).index()+1,h=f.tagName+":nth-child("+i+")";return e&&(h+=" > "+e),this.getSelector(f.parentNode,h)},pointerdblclick:function(e,d,f){this.notify("cell:pointerdblclick",e,d,f)},pointerclick:function(e,d,f){this.notify("cell:pointerclick",e,d,f)},pointerdown:function(e,d,f){this.model.collection&&(this.model.trigger("batch:start",{batchName:"pointer"}),this._collection=this.model.collection),this.notify("cell:pointerdown",e,d,f)},pointermove:function(e,d,f){this.notify("cell:pointermove",e,d,f)},pointerup:function(e,d,f){this.notify("cell:pointerup",e,d,f),this._collection&&(this._collection.trigger("batch:stop",{batchName:"pointer"}),delete this._collection)},mouseover:function(b){this.notify("cell:mouseover",b)},mouseout:function(b){this.notify("cell:mouseout",b)}}),joint.dia.Element=joint.dia.Cell.extend({defaults:{position:{x:0,y:0},size:{width:1,height:1},angle:0},position:function(j,i,o){var n=_.isNumber(i);if(o=(n?o:j)||{},o.parentRelative){if(!this.collection){throw new Error("Element must be part of a collection.")}var m=this.collection.get(this.get("parent")),l=m&&!m.isLink()?m.get("position"):{x:0,y:0}}if(n){return o.parentRelative&&(j+=l.x,i+=l.y),this.set("position",{x:j,y:i},o)}var k=g.point(this.get("position"));return o.parentRelative?k.difference(l):k},translate:function(h,f,k){if(f=f||0,0===h&&0===f){return this}k=k||{},k.translateBy=k.translateBy||this.id,k.tx=h,k.ty=f;var j=this.get("position")||{x:0,y:0},i={x:j.x+h||0,y:j.y+f||0};return k.transition?(_.isObject(k.transition)||(k.transition={}),this.transition("position",i,_.extend({},k.transition,{valueFunction:joint.util.interpolate.object}))):(this.set("position",i,k),_.invoke(this.getEmbeddedCells(),"translate",h,f,k)),this},resize:function(e,d,f){return this.trigger("batch:start",{batchName:"resize"}),this.set("size",{width:e,height:d},f),this.trigger("batch:stop",{batchName:"resize"}),this},fitEmbeds:function(h){h=h||0;var f=this.collection;if(!f){throw new Error("Element must be part of a collection.")}var k=this.getEmbeddedCells();if(k.length>0){this.trigger("batch:start",{batchName:"fit-embeds"}),h.deep&&_.invoke(k,"fitEmbeds",h);var j=f.getBBox(k),i=h.padding||0;i=_.isNumber(i)?{left:i,right:i,top:i,bottom:i}:{left:i.left||0,right:i.right||0,top:i.top||0,bottom:i.bottom||0},j.moveAndExpand({x:-i.left,y:-i.top,width:i.right+i.left,height:i.bottom+i.top}),this.set({position:{x:j.x,y:j.y},size:{width:j.width,height:j.height}},h),this.trigger("batch:stop",{batchName:"fit-embeds"})}return this},rotate:function(j,i,p){if(p){var o=this.getBBox().center(),n=this.get("size"),m=this.get("position");o.rotate(p,this.get("angle")-j);var l=o.x-n.width/2-m.x,k=o.y-n.height/2-m.y;this.trigger("batch:start",{batchName:"rotate"}),this.translate(l,k),this.rotate(j,i),this.trigger("batch:stop",{batchName:"rotate"})}else{this.set("angle",i?j:(this.get("angle")+j)%360)}return this},getBBox:function(){var d=this.get("position"),c=this.get("size");return g.rect(d.x,d.y,c.width,c.height)}}),joint.dia.ElementView=joint.dia.CellView.extend({className:function(){return"element "+this.model.get("type").split(".").join(" ")},initialize:function(){_.bindAll(this,"translate","resize","rotate"),joint.dia.CellView.prototype.initialize.apply(this,arguments),this.listenTo(this.model,"change:position",this.translate),this.listenTo(this.model,"change:size",this.resize),this.listenTo(this.model,"change:angle",this.rotate)},update:function(i,h){var n=this.model.get("attrs"),m=V(this.$(".rotatable")[0]);if(m){var l=m.attr("transform");m.attr("transform","")}var k=[];_.each(h||n,function(o,f){var r=this.findBySelector(f);if(0!==r.length){var q=["style","text","html","ref-x","ref-y","ref-dx","ref-dy","ref-width","ref-height","ref","x-alignment","y-alignment","port"];_.isObject(o.filter)&&(q.push("filter"),this.applyFilter(f,o.filter)),_.isObject(o.fill)&&(q.push("fill"),this.applyGradient(f,"fill",o.fill)),_.isObject(o.stroke)&&(q.push("stroke"),this.applyGradient(f,"stroke",o.stroke)),_.isUndefined(o.text)||(r.each(function(){V(this).text(o.text+"",{lineHeight:o.lineHeight,textPath:o.textPath})}),q.push("lineHeight","textPath"));var p=_.omit(o,q);r.each(function(){V(this).attr(p)}),o.port&&r.attr("port",_.isUndefined(o.port.id)?o.port:o.port.id),o.style&&r.css(o.style),_.isUndefined(o.html)||r.each(function(){$(this).html(o.html+"")}),_.isUndefined(o["ref-x"])&&_.isUndefined(o["ref-y"])&&_.isUndefined(o["ref-dx"])&&_.isUndefined(o["ref-dy"])&&_.isUndefined(o["x-alignment"])&&_.isUndefined(o["y-alignment"])&&_.isUndefined(o["ref-width"])&&_.isUndefined(o["ref-height"])||_.each(r,function(s,e,u){var t=$(s);t.selector=u.selector,k.push(t)})}},this);var j=this.el.getBBox();h=h||{},_.each(k,function(b){var f=h[b.selector],c=f?_.merge({},n[b.selector],f):n[b.selector];this.positionRelative(b,j,c)},this),m&&m.attr("transform",l||"")},positionRelative:function(L,K,J){function I(b){return _.isNumber(b)&&!_.isNaN(b)}var H=J.ref,G=parseFloat(J["ref-x"]),F=parseFloat(J["ref-y"]),E=parseFloat(J["ref-dx"]),D=parseFloat(J["ref-dy"]),C=J["y-alignment"],B=J["x-alignment"],A=parseFloat(J["ref-width"]),z=parseFloat(J["ref-height"]),y=_.contains(_.pluck(_.pluck(L.parents("g"),"className"),"baseVal"),"scalable");H&&(K=V(this.findBySelector(H)[0]).bbox(!1,this.el));var x=V(L[0]);x.attr("transform")&&x.attr("transform",x.attr("transform").replace(/translate\([^)]*\)/g,"").trim()||"");var w=0,v=0;if(I(A)&&(A>=0&&1>=A?x.attr("width",A*K.width):x.attr("width",Math.max(A+K.width,0))),I(z)&&(z>=0&&1>=z?x.attr("height",z*K.height):x.attr("height",Math.max(z+K.height,0))),I(E)){if(y){var u=V(this.$(".scalable")[0]).scale();w=K.x+K.width+E/u.sx}else{w=K.x+K.width+E}}if(I(D)){if(y){var u=V(this.$(".scalable")[0]).scale();v=K.y+K.height+D/u.sy}else{v=K.y+K.height+D}}if(I(G)){if(G>0&&1>G){w=K.x+K.width*G}else{if(y){var u=V(this.$(".scalable")[0]).scale();w=K.x+G/u.sx}else{w=K.x+G}}}if(I(F)){if(F>0&&1>F){v=K.y+K.height*F}else{if(y){var u=V(this.$(".scalable")[0]).scale();v=K.y+F/u.sy}else{v=K.y+F}}}var t=x.bbox(!1,this.paper.viewport);"middle"===C?v-=t.height/2:I(C)&&(v+=C>-1&&1>C?t.height*C:C),"middle"===B?w-=t.width/2:I(B)&&(w+=B>-1&&1>B?t.width*B:B),x.translate(w,v)},renderMarkup:function(){var d=this.model.markup||this.model.get("markup");if(!d){throw new Error("properties.markup is missing while the default render() implementation is used.")}var c=V(d);V(this.el).append(c)},render:function(){return this.$el.empty(),this.renderMarkup(),this.update(),this.resize(),this.rotate(),this.translate(),this},scale:function(d,c){V(this.el).scale(d,c)},resize:function(){var i=this.model.get("size")||{width:1,height:1},h=this.model.get("angle")||0,n=V(this.$(".scalable")[0]);if(n){var m=n.bbox(!0);n.attr("transform","scale("+i.width/(m.width||1)+","+i.height/(m.height||1)+")");var l=V(this.$(".rotatable")[0]),k=l&&l.attr("transform");if(k&&"null"!==k){l.attr("transform",k+" rotate("+-h+","+i.width/2+","+i.height/2+")");var j=n.bbox(!1,this.paper.viewport);this.model.set("position",{x:j.x,y:j.y}),this.rotate()}this.update()}},translate:function(f,e,i){var h=this.model.get("position")||{x:0,y:0};V(this.el).attr("transform","translate("+h.x+","+h.y+")")},rotate:function(){var h=V(this.$(".rotatable")[0]);if(h){var f=this.model.get("angle")||0,k=this.model.get("size")||{width:1,height:1},j=k.width/2,i=k.height/2;h.attr("transform","rotate("+f+","+j+","+i+")")}},getBBox:function(e){if(e&&e.useModelGeometry){var d=this.model.getBBox().bbox(this.model.get("angle")),f=this.paper.viewport.getCTM();return V.transformRect(d,f)}return joint.dia.CellView.prototype.getBBox.apply(this,arguments)},findParentsByKey:function(d){var c=this.model.getBBox();return"bbox"==d?this.paper.model.findModelsInArea(c):this.paper.model.findModelsFromPoint(c[d]())},prepareEmbedding:function(){this.model.toFront({deep:!0,ui:!0}),_.invoke(this.paper.model.getConnectedLinks(this.model,{deep:!0}),"toFront",{ui:!0});var b=this.model.get("parent");b&&this.paper.model.getCell(b).unembed(this.model,{ui:!0})},processEmbedding:function(i){i=i||this.paper.options;var h=this.findParentsByKey(i.findParentBy);h=_.reject(h,function(b){return this.model.id==b.id||b.isEmbeddedIn(this.model)},this),i.frontParentOnly&&(h=h.slice(-1));for(var n=null,m=this._candidateEmbedView,l=h.length-1;l>=0;l--){var k=h[l];if(m&&m.model.id==k.id){n=m;break}var j=k.findView(this.paper);if(i.validateEmbedding.call(this.paper,this,j)){n=j;break}}n&&n!=m&&(m&&m.unhighlight(null,{embedding:!0}),this._candidateEmbedView=n.highlight(null,{embedding:!0})),!n&&m&&(m.unhighlight(null,{embedding:!0}),delete this._candidateEmbedView)},finalizeEmbedding:function(){var b=this._candidateEmbedView;b&&(b.model.embed(this.model,{ui:!0}),b.unhighlight(null,{embedding:!0}),delete this._candidateEmbedView),_.invoke(this.paper.model.getConnectedLinks(this.model,{deep:!0}),"reparent",{ui:!0})},pointerdown:function(f,e,i){if(f.target.getAttribute("magnet")&&this.paper.options.validateMagnet.call(this.paper,this,f.target)){this.model.trigger("batch:start",{batchName:"add-link"});var h=this.paper.getDefaultLink(this,f.target);h.set({source:{id:this.model.id,selector:this.getSelector(f.target),port:$(f.target).attr("port")},target:{x:e,y:i}}),this.paper.model.addCell(h),this._linkView=this.paper.findViewByModel(h),this._linkView.pointerdown(f,e,i),this._linkView.startArrowheadMove("target")}else{this._dx=e,this._dy=i,joint.dia.CellView.prototype.pointerdown.apply(this,arguments),this.notify("element:pointerdown",f,e,i)}},pointermove:function(i,h,m){if(this._linkView){this._linkView.pointermove(i,h,m)}else{var l=this.paper.options.gridSize,k=_.isFunction(this.options.interactive)?this.options.interactive(this,"pointermove"):this.options.interactive;if(k!==!1){var j=this.model.get("position");this.model.translate(g.snapToGrid(j.x,l)-j.x+g.snapToGrid(h-this._dx,l),g.snapToGrid(j.y,l)-j.y+g.snapToGrid(m-this._dy,l)),this.paper.options.embeddingMode&&(this._inProcessOfEmbedding||(this.prepareEmbedding(),this._inProcessOfEmbedding=!0),this.processEmbedding())}this._dx=g.snapToGrid(h,l),this._dy=g.snapToGrid(m,l),joint.dia.CellView.prototype.pointermove.apply(this,arguments),this.notify("element:pointermove",i,h,m)}},pointerup:function(e,d,f){this._linkView?(this._linkView.pointerup(e,d,f),delete this._linkView,this.model.trigger("batch:stop",{batchName:"add-link"})):(this._inProcessOfEmbedding&&(this.finalizeEmbedding(),this._inProcessOfEmbedding=!1),this.notify("element:pointerup",e,d,f),joint.dia.CellView.prototype.pointerup.apply(this,arguments))}}),joint.dia.Link=joint.dia.Cell.extend({markup:['<path class="connection" stroke="black"/>','<path class="marker-source" fill="black" stroke="black" />','<path class="marker-target" fill="black" stroke="black" />','<path class="connection-wrap"/>','<g class="labels"/>','<g class="marker-vertices"/>','<g class="marker-arrowheads"/>','<g class="link-tools"/>'].join(""),labelMarkup:['<g class="label">',"<rect />","<text />","</g>"].join(""),toolMarkup:['<g class="link-tool">','<g class="tool-remove" event="remove">','<circle r="11" />','<path transform="scale(.8) translate(-16, -16)" d="M24.778,21.419 19.276,15.917 24.777,10.415 21.949,7.585 16.447,13.087 10.945,7.585 8.117,10.415 13.618,15.917 8.116,21.419 10.946,24.248 16.447,18.746 21.948,24.248z"/>',"<title>Remove link.</title>","</g>",'<g class="tool-options" event="link:options">','<circle r="11" transform="translate(25)"/>','<path fill="white" transform="scale(.55) translate(29, -16)" d="M31.229,17.736c0.064-0.571,0.104-1.148,0.104-1.736s-0.04-1.166-0.104-1.737l-4.377-1.557c-0.218-0.716-0.504-1.401-0.851-2.05l1.993-4.192c-0.725-0.91-1.549-1.734-2.458-2.459l-4.193,1.994c-0.647-0.347-1.334-0.632-2.049-0.849l-1.558-4.378C17.165,0.708,16.588,0.667,16,0.667s-1.166,0.041-1.737,0.105L12.707,5.15c-0.716,0.217-1.401,0.502-2.05,0.849L6.464,4.005C5.554,4.73,4.73,5.554,4.005,6.464l1.994,4.192c-0.347,0.648-0.632,1.334-0.849,2.05l-4.378,1.557C0.708,14.834,0.667,15.412,0.667,16s0.041,1.165,0.105,1.736l4.378,1.558c0.217,0.715,0.502,1.401,0.849,2.049l-1.994,4.193c0.725,0.909,1.549,1.733,2.459,2.458l4.192-1.993c0.648,0.347,1.334,0.633,2.05,0.851l1.557,4.377c0.571,0.064,1.148,0.104,1.737,0.104c0.588,0,1.165-0.04,1.736-0.104l1.558-4.377c0.715-0.218,1.399-0.504,2.049-0.851l4.193,1.993c0.909-0.725,1.733-1.549,2.458-2.458l-1.993-4.193c0.347-0.647,0.633-1.334,0.851-2.049L31.229,17.736zM16,20.871c-2.69,0-4.872-2.182-4.872-4.871c0-2.69,2.182-4.872,4.872-4.872c2.689,0,4.871,2.182,4.871,4.872C20.871,18.689,18.689,20.871,16,20.871z"/>',"<title>Link options.</title>","</g>","</g>"].join(""),vertexMarkup:['<g class="marker-vertex-group" transform="translate(<%= x %>, <%= y %>)">','<circle class="marker-vertex" idx="<%= idx %>" r="10" />','<path class="marker-vertex-remove-area" idx="<%= idx %>" d="M16,5.333c-7.732,0-14,4.701-14,10.5c0,1.982,0.741,3.833,2.016,5.414L2,25.667l5.613-1.441c2.339,1.317,5.237,2.107,8.387,2.107c7.732,0,14-4.701,14-10.5C30,10.034,23.732,5.333,16,5.333z" transform="translate(5, -33)"/>','<path class="marker-vertex-remove" idx="<%= idx %>" transform="scale(.8) translate(9.5, -37)" d="M24.778,21.419 19.276,15.917 24.777,10.415 21.949,7.585 16.447,13.087 10.945,7.585 8.117,10.415 13.618,15.917 8.116,21.419 10.946,24.248 16.447,18.746 21.948,24.248z">',"<title>Remove vertex.</title>","</path>","</g>"].join(""),arrowheadMarkup:['<g class="marker-arrowhead-group marker-arrowhead-group-<%= end %>">','<path class="marker-arrowhead" end="<%= end %>" d="M 26 0 L 0 13 L 26 26 z" />',"</g>"].join(""),defaults:{type:"link",source:{},target:{}},disconnect:function(){return this.set({source:g.point(0,0),target:g.point(0,0)})},label:function(h,f){h=h||0;var k=this.get("labels")||[];if(0===arguments.length||1===arguments.length){return k[h]}var j=_.merge({},k[h],f),i=k.slice();return i[h]=j,this.set({labels:i})},translate:function(i,h,n){var m={},l=this.get("source"),k=this.get("target"),j=this.get("vertices");return l.id||(m.source={x:l.x+i,y:l.y+h}),k.id||(m.target={x:k.x+i,y:k.y+h}),j&&j.length&&(m.vertices=_.map(j,function(a){return{x:a.x+i,y:a.y+h}})),this.set(m,n)},reparent:function(h){var f;if(this.collection){var k=this.collection.get(this.get("source").id),j=this.collection.get(this.get("target").id),i=this.collection.get(this.get("parent"));k&&j&&(f=this.collection.getCommonAncestor(k,j)),!i||f&&f.id==i.id||i.unembed(this,h),f&&f.embed(this,h)}return f},isLink:function(){return !0},hasLoop:function(){var d=this.get("source").id,c=this.get("target").id;return d&&c&&d==c}}),joint.dia.LinkView=joint.dia.CellView.extend({className:function(){return _.unique(this.model.get("type").split(".").concat("link")).join(" ")},options:{shortLinkLength:100,doubleLinkTools:!1,longLinkLength:160,linkToolsOffset:40,doubleLinkToolsOffset:60,sampleInterval:50},initialize:function(b){joint.dia.CellView.prototype.initialize.apply(this,arguments),"function"!=typeof this.constructor.prototype.watchSource&&(this.constructor.prototype.watchSource=this.createWatcher("source"),this.constructor.prototype.watchTarget=this.createWatcher("target")),this._labelCache={},this._markerCache={},this.startListening()},startListening:function(){this.listenTo(this.model,"change:markup",this.render),this.listenTo(this.model,"change:smooth change:manhattan change:router change:connector",this.update),this.listenTo(this.model,"change:toolMarkup",function(){this.renderTools().updateToolsPosition()}),this.listenTo(this.model,"change:labels change:labelMarkup",function(){this.renderLabels().updateLabelPositions()}),this.listenTo(this.model,"change:vertices change:vertexMarkup",function(e,d,f){this.renderVertexMarkers(),(!f.translateBy||f.translateBy==this.model.id||this.model.hasLoop())&&this.update()}),this.listenTo(this.model,"change:source",function(d,c){this.watchSource(d,c).update()}),this.listenTo(this.model,"change:target",function(d,c){this.watchTarget(d,c).update()})},render:function(){this.$el.empty();var b=V(this.model.get("markup")||this.model.markup);if(_.isArray(b)||(b=[b]),this._V={},_.each(b,function(d){var c=d.attr("class");c&&(this._V[$.camelCase(c)]=d)},this),!this._V.connection){throw new Error("link: no connection path in the markup")}return this.renderTools(),this.renderVertexMarkers(),this.renderArrowheadMarkers(),V(this.el).append(b),this.renderLabels(),this.watchSource(this.model,this.model.get("source")).watchTarget(this.model,this.model.get("target")).update(),this},renderLabels:function(){if(!this._V.labels){return this}this._labelCache={};var h=$(this._V.labels.node).empty(),f=this.model.get("labels")||[];if(!f.length){return this}var k=_.template(this.model.get("labelMarkup")||this.model.labelMarkup),j=V(k()),i=this.can("labelMove");return _.each(f,function(a,p){var o=j.clone().node;V(o).attr("label-idx",p),i&&V(o).attr("cursor","move"),this._labelCache[p]=V(o);var n=$(o).find("text"),m=$(o).find("rect"),l=_.extend({"text-anchor":"middle","font-size":14},joint.util.getByPath(a,"attrs/text","/"));n.attr(_.omit(l,"text")),_.isUndefined(l.text)||V(n[0]).text(l.text+""),h.append(o);var e=V(n[0]).bbox(!0,h[0]);V(n[0]).translate(0,-e.height/2);var d=_.extend({fill:"white",rx:3,ry:3},joint.util.getByPath(a,"attrs/rect","/"));m.attr(_.extend(d,{x:e.x,y:e.y-e.height/2,width:e.width,height:e.height}))},this),this},renderTools:function(){if(!this._V.linkTools){return this}var f=$(this._V.linkTools.node).empty(),e=_.template(this.model.get("toolMarkup")||this.model.toolMarkup),i=V(e());if(f.append(i.node),this._toolCache=i,this.options.doubleLinkTools){var h=i.clone();f.append(h.node),this._tool2Cache=h}return this},renderVertexMarkers:function(){if(!this._V.markerVertices){return this}var d=$(this._V.markerVertices.node).empty(),c=_.template(this.model.get("vertexMarkup")||this.model.vertexMarkup);return _.each(this.model.get("vertices"),function(b,a){d.append(V(c(_.extend({idx:a},b))).node)}),this},renderArrowheadMarkers:function(){if(!this._V.markerArrowheads){return this}var d=$(this._V.markerArrowheads.node);d.empty();var c=_.template(this.model.get("arrowheadMarkup")||this.model.arrowheadMarkup);return this._V.sourceArrowhead=V(c({end:"source"})),this._V.targetArrowhead=V(c({end:"target"})),d.append(this._V.sourceArrowhead.node,this._V.targetArrowhead.node),this},update:function(){_.each(this.model.get("attrs"),function(f,e){var h=[];_.isObject(f.fill)&&(this.applyGradient(e,"fill",f.fill),h.push("fill")),_.isObject(f.stroke)&&(this.applyGradient(e,"stroke",f.stroke),h.push("stroke")),_.isObject(f.filter)&&(this.applyFilter(e,f.filter),h.push("filter")),h.length>0&&(h.unshift(f),f=_.omit.apply(_,h)),this.findBySelector(e).attr(f)},this);var d=this.route=this.findRoute(this.model.get("vertices")||[]);this._findConnectionPoints(d);var c=this.getPathData(d);return this._V.connection.attr("d",c),this._V.connectionWrap&&this._V.connectionWrap.attr("d",c),this._translateAndAutoOrientArrows(this._V.markerSource,this._V.markerTarget),this.updateLabelPositions(),this.updateToolsPosition(),this.updateArrowheadMarkers(),delete this.options.perpendicular,this.updatePostponed=!1,this},_findConnectionPoints:function(k){var j,q,p,o,n=_.first(k);j=this.getConnectionPoint("source",this.model.get("source"),n||this.model.get("target")).round();var m=_.last(k);q=this.getConnectionPoint("target",this.model.get("target"),m||j).round();var l=this._markerCache;this._V.markerSource&&(l.sourceBBox=l.sourceBBox||this._V.markerSource.bbox(!0),p=g.point(j).move(n||q,l.sourceBBox.width*this._V.markerSource.scale().sx*-1).round()),this._V.markerTarget&&(l.targetBBox=l.targetBBox||this._V.markerTarget.bbox(!0),o=g.point(q).move(m||j,l.targetBBox.width*this._V.markerTarget.scale().sx*-1).round()),l.sourcePoint=p||j,l.targetPoint=o||q,this.sourcePoint=j,this.targetPoint=q},updateLabelPositions:function(){if(!this._V.labels){return this}var f=this.model.get("labels")||[];if(!f.length){return this}var e=this._V.connection.node,i=e.getTotalLength();if(!_.isNaN(i)){var h;_.each(f,function(E,D){var C=E.position,B=_.isObject(C)?C.distance:C,A=_.isObject(C)?C.offset:{x:0,y:0};B=B>i?i:B,B=0>B?i+B:B,B=B>1?B:i*B;var z=e.getPointAtLength(B);if(_.isObject(A)){z=g.point(z).offset(A.x,A.y)}else{if(_.isNumber(A)){h||(h=this._samples||this._V.connection.sample(this.options.sampleInterval));for(var y,x,w,v,u=1/0,d=0,c=h.length;c>d;d++){w=h[d],v=g.line(w,z).squaredLength(),u>v&&(u=v,y=w,x=d)}var b=h[x-1],G=h[x+1],F=0;G?F=g.point(z).theta(G):b&&(F=g.point(b).theta(z)),z=g.point(z).offset(A).rotate(z,F-90)}}this._labelCache[D].attr("transform","translate("+z.x+", "+z.y+")")},this)}return this},updateToolsPosition:function(){if(!this._V.linkTools){return this}var h="",f=this.options.linkToolsOffset,k=this.getConnectionLength();if(!_.isNaN(k)){k<this.options.shortLinkLength&&(h="scale(.5)",f/=2);var j=this.getPointAtLength(f);if(this._toolCache.attr("transform","translate("+j.x+", "+j.y+") "+h),this.options.doubleLinkTools&&k>=this.options.longLinkLength){var i=this.options.doubleLinkToolsOffset||f;j=this.getPointAtLength(k-i),this._tool2Cache.attr("transform","translate("+j.x+", "+j.y+") "+h),this._tool2Cache.attr("visibility","visible")}else{this.options.doubleLinkTools&&this._tool2Cache.attr("visibility","hidden")}}return this},updateArrowheadMarkers:function(){if(!this._V.markerArrowheads){return this}if("none"===$.css(this._V.markerArrowheads.node,"display")){return this}var b=this.getConnectionLength()<this.options.shortLinkLength?0.5:1;return this._V.sourceArrowhead.scale(b),this._V.targetArrowhead.scale(b),this._translateAndAutoOrientArrows(this._V.sourceArrowhead,this._V.targetArrowhead),this},createWatcher:function(e){function d(a,i){i=i||{};var h=null,c=a.previous(e)||{};return c.id&&this.stopListening(this.paper.getModelById(c.id),"change",f),i.id&&(h=this.paper.getModelById(i.id),this.listenTo(h,"change",f)),f.call(this,h,{cacheOnly:!0}),this}var f=_.partial(this.onEndModelChange,e);return d},onEndModelChange:function(A,z,y){var x=!y.cacheOnly,w=this.model.get(A)||{};if(z){var v=this.constructor.makeSelector(w),u="source"==A?"target":"source",t=this.model.get(u)||{},s=t.id&&this.constructor.makeSelector(t);if(y.isLoop&&v==s){this[A+"BBox"]=this[u+"BBox"],this[A+"View"]=this[u+"View"],this[A+"Magnet"]=this[u+"Magnet"]}else{if(y.translateBy){var r=this[A+"BBox"];r.x+=y.tx,r.y+=y.ty}else{var q=this.paper.findViewByModel(w.id),p=q.el.querySelector(v);this[A+"BBox"]=q.getStrokeBBox(p),this[A+"View"]=q,this[A+"Magnet"]=p}}if(y.isLoop&&y.translateBy&&this.model.isEmbeddedIn(z)&&!_.isEmpty(this.model.get("vertices"))&&(x=!1),!this.updatePostponed&&t.id){var o=this.paper.getModelById(t.id);y.isLoop=w.id==t.id,(y.isLoop||y.translateBy&&o.isEmbeddedIn(y.translateBy))&&(this.updatePostponed=!0,x=!1)}}else{this[A+"BBox"]=g.rect(w.x||0,w.y||0,1,1),this[A+"View"]=this[A+"Magnet"]=null}this.lastEndChange=A,x&&this.update()},_translateAndAutoOrientArrows:function(d,c){d&&d.translateAndAutoOrient(this.sourcePoint,_.first(this.route)||this.targetPoint,this.paper.viewport),c&&c.translateAndAutoOrient(this.targetPoint,_.last(this.route)||this.sourcePoint,this.paper.viewport)},removeVertex:function(d){var c=_.clone(this.model.get("vertices"));return c&&c.length&&(c.splice(d,1),this.model.set("vertices",c,{ui:!0})),this},addVertex:function(j){for(var i,p=(this.model.get("vertices")||[]).slice(),o=p.slice(),n=this._V.connection.node.cloneNode(!1),m=n.getTotalLength(),l=20,k=p.length+1;k--&&(p.splice(k,0,j),V(n).attr("d",this.getPathData(this.findRoute(p))),i=n.getTotalLength(),i-m>l);){p=o.slice()}return -1===k&&(k=0,p.splice(k,0,j)),this.model.set("vertices",p,{ui:!0}),k},sendToken:function(e,d,f){d=d||1000,V(this.paper.viewport).append(e),V(e).animateAlongPath({dur:d+"ms",repeatCount:1},this._V.connection.node),_.delay(function(){V(e).remove(),f&&f()},d)},findRoute:function(f){var e=this.model.get("router");if(!e){if(!this.model.get("manhattan")){return f}e={name:"orthogonal"}}var i=joint.routers[e.name];if(!_.isFunction(i)){throw"unknown router: "+e.name}var h=i.call(this,f||[],e.args||{},this);return h},getPathData:function(e){var d=this.model.get("connector");if(d||(d=this.model.get("smooth")?{name:"smooth"}:{name:"normal"}),!_.isFunction(joint.connectors[d.name])){throw"unknown connector: "+d.name}var f=joint.connectors[d.name].call(this,this._markerCache.sourcePoint,this._markerCache.targetPoint,e||this.model.get("vertices")||{},d.args||{},this);return f},getConnectionPoint:function(y,x,w){var v;if(_.isEmpty(x)&&(x={x:0,y:0}),_.isEmpty(w)&&(w={x:0,y:0}),x.id){var u,t="source"===y?this.sourceBBox:this.targetBBox;if(w.id){var s="source"===y?this.targetBBox:this.sourceBBox;u=g.rect(s).intersectionWithLineFromCenterToPoint(g.rect(t).center()),u=u||g.rect(s).center()}else{u=g.point(w)}if(this.paper.options.perpendicularLinks||this.options.perpendicular){var r,q=g.rect(0,u.y,this.paper.options.width,1),p=g.rect(u.x,0,1,this.paper.options.height);if(q.intersect(g.rect(t))){switch(r=g.rect(t).sideNearestToPoint(u)){case"left":v=g.point(t.x,u.y);break;case"right":v=g.point(t.x+t.width,u.y);break;default:v=g.rect(t).center()}}else{if(p.intersect(g.rect(t))){switch(r=g.rect(t).sideNearestToPoint(u)){case"top":v=g.point(u.x,t.y);break;case"bottom":v=g.point(u.x,t.y+t.height);break;default:v=g.rect(t).center()}}else{v=g.rect(t).intersectionWithLineFromCenterToPoint(u),v=v||g.rect(t).center()}}}else{if(this.paper.options.linkConnectionPoint){var o="target"===y?this.targetView:this.sourceView,n="target"===y?this.targetMagnet:this.sourceMagnet;v=this.paper.options.linkConnectionPoint(this,o,n,u)}else{v=g.rect(t).intersectionWithLineFromCenterToPoint(u),v=v||g.rect(t).center()}}}else{v=g.point(x)}return v},getConnectionLength:function(){return this._V.connection.node.getTotalLength()},getPointAtLength:function(b){return this._V.connection.node.getPointAtLength(b)},_beforeArrowheadMove:function(){this._z=this.model.get("z"),this.model.toFront(),this.el.style.pointerEvents="none",this.paper.options.markAvailable&&this._markAvailableMagnets()},_afterArrowheadMove:function(){this._z&&(this.model.set("z",this._z,{ui:!0}),delete this._z),this.el.style.pointerEvents="visiblePainted",this.paper.options.markAvailable&&this._unmarkAvailableMagnets()},_createValidateConnectionArgs:function(i){function h(d,c){return n[k]=d,n[k+1]=d.el===c?void 0:c,n}var n=[];n[4]=i,n[5]=this;var m,l=0,k=0;"source"===i?(l=2,m="target"):(k=2,m="source");var j=this.model.get(m);return j.id&&(n[l]=this.paper.findViewByModel(j.id),n[l+1]=j.selector&&n[l].el.querySelector(j.selector)),h},_markAvailableMagnets:function(){var d=this.paper.model.getElements(),c=this.paper.options.validateConnection;_.chain(d).map(this.paper.findViewByModel,this.paper).each(function(b){var f="false"!==b.el.getAttribute("magnet")&&c.apply(this.paper,this._validateConnectionArgs(b,null)),e=_.filter(b.el.querySelectorAll("[magnet]"),function(a){return c.apply(this.paper,this._validateConnectionArgs(b,a))},this);f&&V(b.el).addClass("available-magnet"),_.each(e,function(h){V(h).addClass("available-magnet")}),(f||e.length)&&V(b.el).addClass("available-cell")},this)},_unmarkAvailableMagnets:function(){_.each(this.paper.el.querySelectorAll(".available-cell, .available-magnet"),function(b){V(b).removeClass("available-magnet").removeClass("available-cell")})},startArrowheadMove:function(b){this._action="arrowhead-move",this._arrowhead=b,this._validateConnectionArgs=this._createValidateConnectionArgs(this._arrowhead),this._beforeArrowheadMove()},can:function(d){var c=_.isFunction(this.options.interactive)?this.options.interactive(this,"pointerdown"):this.options.interactive;return _.isObject(c)&&c[d]===!1?!1:!0},pointerdown:function(j,i,p){if(joint.dia.CellView.prototype.pointerdown.apply(this,arguments),this.notify("link:pointerdown",j,i,p),this._dx=i,this._dy=p,null==j.target.getAttribute("magnet")){var o=_.isFunction(this.options.interactive)?this.options.interactive(this,"pointerdown"):this.options.interactive;if(o!==!1){var n,m=j.target.getAttribute("class"),l=j.target.parentNode.getAttribute("class");switch("label"===l?(m=l,n=j.target.parentNode):n=j.target,m){case"marker-vertex":this.can("vertexMove")&&(this._action="vertex-move",this._vertexIdx=j.target.getAttribute("idx"));break;case"marker-vertex-remove":case"marker-vertex-remove-area":this.can("vertexRemove")&&this.removeVertex(j.target.getAttribute("idx"));break;case"marker-arrowhead":this.can("arrowheadMove")&&this.startArrowheadMove(j.target.getAttribute("end"));break;case"label":this.can("labelMove")&&(this._action="label-move",this._labelIdx=parseInt(V(n).attr("label-idx"),10),this._samples=this._V.connection.sample(1),this._linkLength=this._V.connection.node.getTotalLength());break;default:var k=j.target.parentNode.getAttribute("event");k?"remove"===k?this.model.remove():this.paper.trigger(k,j,this,i,p):this.can("vertexAdd")&&(this._vertexIdx=this.addVertex({x:i,y:p}),this._action="vertex-move")}}}},pointermove:function(S,R,Q){switch(this._action){case"vertex-move":var P=_.clone(this.model.get("vertices"));P[this._vertexIdx]={x:R,y:Q},this.model.set("vertices",P,{ui:!0});break;case"label-move":for(var O,N,M,L,K={x:R,y:Q},J=(this.model.get("labels")[this._labelIdx],this._samples),I=1/0,H=0,G=J.length;G>H;H++){M=J[H],L=g.line(M,K).squaredLength(),I>L&&(I=L,O=M,N=H)}var F=J[N-1],E=J[N+1],D=(g.point(O).distance(K),0);F&&E?D=g.line(F,E).pointOffset(K):F?D=g.line(F,O).pointOffset(K):E&&(D=g.line(O,E).pointOffset(K)),this.model.label(this._labelIdx,{position:{distance:O.distance/this._linkLength,offset:D}});break;case"arrowhead-move":if(this.paper.options.snapLinks){var C=this.paper.options.snapLinks.radius||50,B=this.paper.findViewsInArea({x:R-C,y:Q-C,width:2*C,height:2*C});this._closestView&&this._closestView.unhighlight(this._closestEnd.selector,{connecting:!0,snapping:!0}),this._closestView=this._closestEnd=null;var A,z=Number.MAX_VALUE,y=g.point(R,Q);_.each(B,function(b){"false"!==b.el.getAttribute("magnet")&&(A=b.model.getBBox().center().distance(y),C>A&&z>A&&this.paper.options.validateConnection.apply(this.paper,this._validateConnectionArgs(b,null))&&(z=A,this._closestView=b,this._closestEnd={id:b.model.id})),b.$("[magnet]").each(_.bind(function(a,f){var e=V(f).bbox(!1,this.paper.viewport);A=y.distance({x:e.x+e.width/2,y:e.y+e.height/2}),C>A&&z>A&&this.paper.options.validateConnection.apply(this.paper,this._validateConnectionArgs(b,f))&&(z=A,this._closestView=b,this._closestEnd={id:b.model.id,selector:b.getSelector(f),port:f.getAttribute("port")})},this))},this),this._closestView&&this._closestView.highlight(this._closestEnd.selector,{connecting:!0,snapping:!0}),this.model.set(this._arrowhead,this._closestEnd||{x:R,y:Q},{ui:!0})}else{var x="mousemove"===S.type?S.target:document.elementFromPoint(S.clientX,S.clientY);this._targetEvent!==x&&(this._magnetUnderPointer&&this._viewUnderPointer.unhighlight(this._magnetUnderPointer,{connecting:!0}),this._viewUnderPointer=this.paper.findView(x),this._viewUnderPointer?(this._magnetUnderPointer=this._viewUnderPointer.findMagnet(x),this._magnetUnderPointer&&this.paper.options.validateConnection.apply(this.paper,this._validateConnectionArgs(this._viewUnderPointer,this._magnetUnderPointer))?this._magnetUnderPointer&&this._viewUnderPointer.highlight(this._magnetUnderPointer,{connecting:!0}):this._magnetUnderPointer=null):this._magnetUnderPointer=null),this._targetEvent=x,this.model.set(this._arrowhead,{x:R,y:Q},{ui:!0})}}this._dx=R,this._dy=Q,joint.dia.CellView.prototype.pointermove.apply(this,arguments),this.notify("link:pointermove",S,R,Q)},pointerup:function(e,d,f){"label-move"===this._action?this._samples=null:"arrowhead-move"===this._action&&(this.paper.options.snapLinks?(this._closestView&&this._closestView.unhighlight(this._closestEnd.selector,{connecting:!0,snapping:!0}),this._closestView=this._closestEnd=null):(this._magnetUnderPointer&&(this._viewUnderPointer.unhighlight(this._magnetUnderPointer,{connecting:!0}),this.model.set(this._arrowhead,{id:this._viewUnderPointer.model.id,selector:this._viewUnderPointer.getSelector(this._magnetUnderPointer),port:$(this._magnetUnderPointer).attr("port")},{ui:!0})),delete this._viewUnderPointer,delete this._magnetUnderPointer),this.paper.options.embeddingMode&&this.model.reparent()&&delete this._z,this._afterArrowheadMove()),delete this._action,this.notify("link:pointerup",e,d,f),joint.dia.CellView.prototype.pointerup.apply(this,arguments)}},{makeSelector:function(d){var c='[model-id="'+d.id+'"]';return d.port?c+=' [port="'+d.port+'"]':d.selector&&(c+=" "+d.selector),c}}),joint.dia.Paper=Backbone.View.extend({className:"paper",options:{width:800,height:600,origin:{x:0,y:0},gridSize:50,perpendicularLinks:!1,elementView:joint.dia.ElementView,linkView:joint.dia.LinkView,snapLinks:!1,markAvailable:!1,defaultLink:new joint.dia.Link,validateMagnet:function(d,c){return"passive"!==c.getAttribute("magnet")},validateConnection:function(i,h,m,l,k,j){return("target"===k?m:i) instanceof joint.dia.ElementView},embeddingMode:!1,validateEmbedding:function(d,c){return !0},findParentBy:"bbox",frontParentOnly:!0,interactive:{labelMove:!1}},events:{mousedown:"pointerdown",dblclick:"mousedblclick",click:"mouseclick",touchstart:"pointerdown",mousemove:"pointermove",touchmove:"pointermove","mouseover .element":"cellMouseover","mouseover .link":"cellMouseover","mouseout .element":"cellMouseout","mouseout .link":"cellMouseout"},constructor:function(b){this._configure(b),Backbone.View.apply(this,arguments)},_configure:function(b){this.options&&(b=_.extend({},_.result(this,"options"),b)),this.options=b},initialize:function(){_.bindAll(this,"addCell","sortCells","resetCells","pointerup","asyncRenderCells"),this.svg=V("svg").node,this.viewport=V("g").addClass("viewport").node,this.defs=V("defs").node,V(this.svg).append([this.viewport,this.defs]),this.$el.append(this.svg),this.setOrigin(),this.setDimensions(),this.listenTo(this.model,"add",this.onAddCell),this.listenTo(this.model,"reset",this.resetCells),this.listenTo(this.model,"sort",this.sortCells),$(document).on("mouseup touchend",this.pointerup),this._mousemoved=!1,this.on({"cell:highlight":this.onCellHighlight,"cell:unhighlight":this.onCellUnhighlight})},remove:function(){this.removeCells(),$(document).off("mouseup touchend",this.pointerup),Backbone.View.prototype.remove.call(this)},setDimensions:function(d,c){d=this.options.width=d||this.options.width,c=this.options.height=c||this.options.height,V(this.svg).attr({width:d,height:c}),this.trigger("resize",d,c)},setOrigin:function(d,c){this.options.origin.x=d||0,this.options.origin.y=c||0,V(this.viewport).translate(d,c,{absolute:!0}),this.trigger("translate",d,c)},fitToContent:function(x,w,v,u){_.isObject(x)?(u=x,x=u.gridWidth||1,w=u.gridHeight||1,v=u.padding||0):(u=u||{},x=x||1,w=w||1,v=v||0),v=_.isNumber(v)?{left:v,right:v,top:v,bottom:v}:{left:v.left||0,right:v.right||0,top:v.top||0,bottom:v.bottom||0};var t=V(this.viewport).bbox(!0,this.svg),s=V(this.viewport).scale();t.x*=s.sx,t.y*=s.sy,t.width*=s.sx,t.height*=s.sy;var r=Math.max(Math.ceil((t.width+t.x)/x),1)*x,q=Math.max(Math.ceil((t.height+t.y)/w),1)*w,p=0,o=0;("negative"==u.allowNewOrigin&&t.x<0||"positive"==u.allowNewOrigin&&t.x>=0||"any"==u.allowNewOrigin)&&(p=Math.ceil(-t.x/x)*x,p+=v.left,r+=p),("negative"==u.allowNewOrigin&&t.y<0||"positive"==u.allowNewOrigin&&t.y>=0||"any"==u.allowNewOrigin)&&(o=Math.ceil(-t.y/w)*w,o+=v.top,q+=o),r+=v.right,q+=v.bottom,r=Math.max(r,u.minWidth||0),q=Math.max(q,u.minHeight||0);var n=r!=this.options.width||q!=this.options.height,m=p!=this.options.origin.x||o!=this.options.origin.y;m&&this.setOrigin(p,o),n&&this.setDimensions(r,q)},scaleContentToFit:function(E){var D=this.getContentBBox();if(D.width&&D.height){E=E||{},_.defaults(E,{padding:0,preserveAspectRatio:!0,scaleGrid:null,minScale:0,maxScale:Number.MAX_VALUE});var C=E.padding,B=E.minScaleX||E.minScale,A=E.maxScaleX||E.maxScale,z=E.minScaleY||E.minScale,y=E.maxScaleY||E.maxScale,x=E.fittingBBox||{x:this.options.origin.x,y:this.options.origin.y,width:this.options.width,height:this.options.height};x=g.rect(x).moveAndExpand({x:C,y:C,width:-2*C,height:-2*C});var w=V(this.viewport).scale(),v=x.width/D.width*w.sx,u=x.height/D.height*w.sy;if(E.preserveAspectRatio&&(v=u=Math.min(v,u)),E.scaleGrid){var t=E.scaleGrid;v=t*Math.floor(v/t),u=t*Math.floor(u/t)}v=Math.min(A,Math.max(B,v)),u=Math.min(y,Math.max(z,u)),this.scale(v,u);var s=this.getContentBBox(),r=x.x-s.x,q=x.y-s.y;this.setOrigin(r,q)}},getContentBBox:function(){var f=this.viewport.getBoundingClientRect(),e=this.viewport.getScreenCTM(),i=this.viewport.getCTM(),h=g.rect({x:f.left-e.e+i.e,y:f.top-e.f+i.f,width:f.width,height:f.height});return h},createViewForModel:function(h){var f,k=h.get("type"),j=k.split(".")[0],i=k.split(".")[1];return f=joint.shapes[j]&&joint.shapes[j][i+"View"]?new joint.shapes[j][i+"View"]({model:h,interactive:this.options.interactive}):h instanceof joint.dia.Element?new this.options.elementView({model:h,interactive:this.options.interactive}):new this.options.linkView({model:h,interactive:this.options.interactive})},onAddCell:function(e,d,f){if(this.options.async&&f.async!==!1&&_.isNumber(f.position)){if(this._asyncCells=this._asyncCells||[],this._asyncCells.push(e),0==f.position){if(this._frameId){throw"another asynchronous rendering in progress"}this.asyncRenderCells(this._asyncCells),delete this._asyncCells}}else{this.addCell(e)}},addCell:function(d){var c=this.createViewForModel(d);V(this.viewport).append(c.el),c.paper=this,c.render(),$(c.el).find("image").on("dragstart",function(){return !1})},beforeRenderCells:function(b){return b.sort(function(d,c){return d instanceof joint.dia.Link?1:-1}),b},afterRenderCells:function(){this.sortCells()},resetCells:function(e,d){$(this.viewport).empty();var f=e.models.slice();f=this.beforeRenderCells(f,d),this._frameId&&(joint.util.cancelFrame(this._frameId),delete this._frameId),this.options.async?this.asyncRenderCells(f,d):(_.each(f,this.addCell,this),this.sortCells())},removeCells:function(){this.model.get("cells").each(function(d){var c=this.findViewByModel(d);c&&c.remove()},this)},asyncBatchAdded:_.identity,asyncRenderCells:function(e,d){var f=!1;this._frameId&&(_.each(_.range(this.options.async&&this.options.async.batchSize||50),function(){var a=e.shift();f=!a,f||this.addCell(a)},this),this.asyncBatchAdded()),f?(delete this._frameId,this.afterRenderCells(d),this.trigger("render:done",d)):this._frameId=joint.util.nextFrame(_.bind(function(){this.asyncRenderCells(e,d)},this))},sortCells:function(){var d=$(this.viewport).children("[model-id]"),c=this.model.get("cells");this.sortElements(d,function(b,i){var h=c.get($(b).attr("model-id")),f=c.get($(i).attr("model-id"));return(h.get("z")||0)>(f.get("z")||0)?1:-1})},sortElements:function(f,e){var i=$(f),h=i.map(function(){var j=this,d=j.parentNode,k=d.insertBefore(document.createTextNode(""),j.nextSibling);return function(){if(d===this){throw new Error("You can't sort elements if any one is a descendant of another.")}d.insertBefore(this,k),d.removeChild(k)}});return Array.prototype.sort.call(i,e).each(function(b){h[b].call(this)})},scale:function(j,i,p,o){i=i||j,_.isUndefined(p)&&(p=0,o=0),V(this.viewport).attr("transform","");var n=this.options.origin.x,m=this.options.origin.y;if(p||o||n||m){var l=n-p*(j-1),k=m-o*(i-1);this.setOrigin(l,k)}return V(this.viewport).scale(j,i),this.trigger("scale",j,i,p,o),this},rotate:function(f,e,i){if(_.isUndefined(e)){var h=this.viewport.getBBox();e=h.width/2,i=h.height/2}V(this.viewport).rotate(f,e,i)},findView:function(d){var c=this.$(d);return 0===c.length||c[0]===this.el?void 0:c.data("view")||this.findView(c.parent())},findViewByModel:function(e){var d=_.isString(e)?e:e.id,f=this.$('[model-id="'+d+'"]');return f.length?f.data("view"):void 0},findViewsFromPoint:function(d){d=g.point(d);var c=_.map(this.model.getElements(),this.findViewByModel);return _.filter(c,function(a){return a&&g.rect(V(a.el).bbox(!1,this.viewport)).containsPoint(d)},this)},findViewsInArea:function(d){d=g.rect(d);var c=_.map(this.model.getElements(),this.findViewByModel);return _.filter(c,function(a){return a&&d.intersect(g.rect(V(a.el).bbox(!1,this.viewport)))},this)},getModelById:function(b){return this.model.getCell(b)},snapToGrid:function(d){var c=V(this.viewport).toLocalPoint(d.x,d.y);return{x:g.snapToGrid(c.x,this.options.gridSize),y:g.snapToGrid(c.y,this.options.gridSize)}},clientToLocalPoint:function(i){var h=this.svg.createSVGPoint();h.x=i.x,h.y=i.y;var n=V("rect",{width:this.options.width,height:this.options.height,x:0,y:0,opacity:0});V(this.svg).prepend(n);var m=$(this.svg).offset();n.remove();var l=document.body.scrollTop||document.documentElement.scrollTop,k=document.body.scrollLeft||document.documentElement.scrollLeft;h.x+=k-m.left,h.y+=l-m.top;var j=h.matrixTransform(this.viewport.getCTM().inverse());return j},getDefaultLink:function(d,c){return _.isFunction(this.options.defaultLink)?this.options.defaultLink.call(this,d,c):this.options.defaultLink.clone()},onCellHighlight:function(d,c){V(c).addClass("highlighted")},onCellUnhighlight:function(d,c){V(c).removeClass("highlighted")},mousedblclick:function(e){e.preventDefault(),e=joint.util.normalizeEvent(e);var d=this.findView(e.target),f=this.snapToGrid({x:e.clientX,y:e.clientY});d?d.pointerdblclick(e,f.x,f.y):this.trigger("blank:pointerdblclick",e,f.x,f.y)},mouseclick:function(e){if(!this._mousemoved){e=joint.util.normalizeEvent(e);var d=this.findView(e.target),f=this.snapToGrid({x:e.clientX,y:e.clientY});d?d.pointerclick(e,f.x,f.y):this.trigger("blank:pointerclick",e,f.x,f.y)}this._mousemoved=!1},pointerdown:function(e){e=joint.util.normalizeEvent(e);var d=this.findView(e.target),f=this.snapToGrid({x:e.clientX,y:e.clientY});d?(this.sourceView=d,d.pointerdown(e,f.x,f.y)):this.trigger("blank:pointerdown",e,f.x,f.y)},pointermove:function(d){if(d.preventDefault(),d=joint.util.normalizeEvent(d),this.sourceView){this._mousemoved=!0;var c=this.snapToGrid({x:d.clientX,y:d.clientY});this.sourceView.pointermove(d,c.x,c.y)}},pointerup:function(d){d=joint.util.normalizeEvent(d);var c=this.snapToGrid({x:d.clientX,y:d.clientY});this.sourceView?(this.sourceView.pointerup(d,c.x,c.y),this.sourceView=null):this.trigger("blank:pointerup",d,c.x,c.y)},cellMouseover:function(d){d=joint.util.normalizeEvent(d);var c=this.findView(d.target);c&&c.mouseover(d)},cellMouseout:function(d){d=joint.util.normalizeEvent(d);var c=this.findView(d.target);c&&c.mouseout(d)}}),joint.shapes.basic={},joint.shapes.basic.Generic=joint.dia.Element.extend({defaults:joint.util.deepSupplement({type:"basic.Generic",attrs:{".":{fill:"#FFFFFF",stroke:"none"}}},joint.dia.Element.prototype.defaults)}),joint.shapes.basic.Rect=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><rect/></g><text/></g>',defaults:joint.util.deepSupplement({type:"basic.Rect",attrs:{rect:{fill:"#FFFFFF",stroke:"black",width:100,height:60},text:{"font-size":14,text:"","ref-x":0.5,"ref-y":0.5,ref:"rect","y-alignment":"middle","x-alignment":"middle",fill:"black","font-family":"Arial, helvetica, sans-serif"}}},joint.shapes.basic.Generic.prototype.defaults)}),joint.shapes.basic.TextView=joint.dia.ElementView.extend({initialize:function(){joint.dia.ElementView.prototype.initialize.apply(this,arguments),this.listenTo(this.model,"change:attrs",this.resize)}}),joint.shapes.basic.Text=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><text/></g></g>',defaults:joint.util.deepSupplement({type:"basic.Text",attrs:{text:{"font-size":18,fill:"black"}}},joint.shapes.basic.Generic.prototype.defaults)}),joint.shapes.basic.Circle=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><circle/></g><text/></g>',defaults:joint.util.deepSupplement({type:"basic.Circle",size:{width:60,height:60},attrs:{circle:{fill:"#FFFFFF",stroke:"black",r:30,transform:"translate(30, 30)"},text:{"font-size":14,text:"","text-anchor":"middle","ref-x":0.5,"ref-y":0.5,ref:"circle","y-alignment":"middle",fill:"black","font-family":"Arial, helvetica, sans-serif"}}},joint.shapes.basic.Generic.prototype.defaults)}),joint.shapes.basic.Ellipse=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><ellipse/></g><text/></g>',defaults:joint.util.deepSupplement({type:"basic.Ellipse",size:{width:60,height:40},attrs:{ellipse:{fill:"#FFFFFF",stroke:"black",rx:30,ry:20,transform:"translate(30, 20)"},text:{"font-size":14,text:"","text-anchor":"middle","ref-x":0.5,"ref-y":0.5,ref:"ellipse","y-alignment":"middle",fill:"black","font-family":"Arial, helvetica, sans-serif"}}},joint.shapes.basic.Generic.prototype.defaults)}),joint.shapes.basic.Polygon=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><polygon/></g><text/></g>',defaults:joint.util.deepSupplement({type:"basic.Polygon",size:{width:60,height:40},attrs:{polygon:{fill:"#FFFFFF",stroke:"black"},text:{"font-size":14,text:"","text-anchor":"middle","ref-x":0.5,"ref-dy":20,ref:"polygon","y-alignment":"middle",fill:"black","font-family":"Arial, helvetica, sans-serif"}}},joint.shapes.basic.Generic.prototype.defaults)}),joint.shapes.basic.Polyline=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><polyline/></g><text/></g>',defaults:joint.util.deepSupplement({type:"basic.Polyline",size:{width:60,height:40},attrs:{polyline:{fill:"#FFFFFF",stroke:"black"},text:{"font-size":14,text:"","text-anchor":"middle","ref-x":0.5,"ref-dy":20,ref:"polyline","y-alignment":"middle",fill:"black","font-family":"Arial, helvetica, sans-serif"}}},joint.shapes.basic.Generic.prototype.defaults)}),joint.shapes.basic.Image=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><image/></g><text/></g>',defaults:joint.util.deepSupplement({type:"basic.Image",attrs:{text:{"font-size":14,text:"","text-anchor":"middle","ref-x":0.5,"ref-dy":20,ref:"image","y-alignment":"middle",fill:"black","font-family":"Arial, helvetica, sans-serif"}}},joint.shapes.basic.Generic.prototype.defaults)}),joint.shapes.basic.Path=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><path/></g><text/></g>',defaults:joint.util.deepSupplement({type:"basic.Path",size:{width:60,height:60},attrs:{path:{fill:"#FFFFFF",stroke:"black"},text:{"font-size":14,text:"","text-anchor":"middle","ref-x":0.5,"ref-dy":20,ref:"path","y-alignment":"middle",fill:"black","font-family":"Arial, helvetica, sans-serif"}}},joint.shapes.basic.Generic.prototype.defaults)}),joint.shapes.basic.Rhombus=joint.shapes.basic.Path.extend({defaults:joint.util.deepSupplement({type:"basic.Rhombus",attrs:{path:{d:"M 30 0 L 60 30 30 60 0 30 z"},text:{"ref-y":0.5}}},joint.shapes.basic.Path.prototype.defaults)}),joint.shapes.basic.PortsModelInterface={initialize:function(){this.updatePortsAttrs(),this.on("change:inPorts change:outPorts",this.updatePortsAttrs,this),this.constructor.__super__.constructor.__super__.initialize.apply(this,arguments)},updatePortsAttrs:function(e){var d=this.get("attrs");_.each(this._portSelectors,function(b){d[b]&&delete d[b]}),this._portSelectors=[];var f={};_.each(this.get("inPorts"),function(h,c,j){var i=this.getPortAttrs(h,c,j.length,".inPorts","in");this._portSelectors=this._portSelectors.concat(_.keys(i)),_.extend(f,i)},this),_.each(this.get("outPorts"),function(h,c,j){var i=this.getPortAttrs(h,c,j.length,".outPorts","out");this._portSelectors=this._portSelectors.concat(_.keys(i)),_.extend(f,i)},this),this.attr(f,{silent:!0}),this.processPorts(),this.trigger("process:ports")},getPortSelector:function(e){var d=".inPorts",f=this.get("inPorts").indexOf(e);if(0>f&&(d=".outPorts",f=this.get("outPorts").indexOf(e),0>f)){throw new Error("getPortSelector(): Port doesn't exist.")}return d+">g:nth-child("+(f+1)+")>circle"}},joint.shapes.basic.PortsViewInterface={initialize:function(){this.listenTo(this.model,"process:ports",this.update),joint.dia.ElementView.prototype.initialize.apply(this,arguments)},update:function(){this.renderPorts(),joint.dia.ElementView.prototype.update.apply(this,arguments)},renderPorts:function(){var e=this.$(".inPorts").empty(),d=this.$(".outPorts").empty(),f=_.template(this.model.portMarkup);_.each(_.filter(this.model.ports,function(b){return"in"===b.type}),function(a,c){e.append(V(f({id:c,port:a})).node)}),_.each(_.filter(this.model.ports,function(b){return"out"===b.type}),function(b,c){d.append(V(f({id:c,port:b})).node)})}},joint.shapes.basic.TextBlock=joint.shapes.basic.Generic.extend({markup:['<g class="rotatable"><g class="scalable"><rect/></g><switch>','<foreignObject requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" class="fobj">','<body xmlns="http://www.w3.org/1999/xhtml"><div/></body>',"</foreignObject>",'<text class="content"/>',"</switch></g>"].join(""),defaults:joint.util.deepSupplement({type:"basic.TextBlock",attrs:{rect:{fill:"#ffffff",stroke:"#000000",width:80,height:100},text:{fill:"#000000","font-size":14,"font-family":"Arial, helvetica, sans-serif"},".content":{text:"",ref:"rect","ref-x":0.5,"ref-y":0.5,"y-alignment":"middle","x-alignment":"middle"}},content:""},joint.shapes.basic.Generic.prototype.defaults),initialize:function(){"undefined"!=typeof SVGForeignObjectElement&&(this.setForeignObjectSize(this,this.get("size")),this.setDivContent(this,this.get("content")),this.listenTo(this,"change:size",this.setForeignObjectSize),this.listenTo(this,"change:content",this.setDivContent)),joint.shapes.basic.Generic.prototype.initialize.apply(this,arguments)},setForeignObjectSize:function(d,c){d.attr({".fobj":_.clone(c),div:{style:_.clone(c)}})},setDivContent:function(d,c){d.attr({div:{html:c}})}}),joint.shapes.basic.TextBlockView=joint.dia.ElementView.extend({initialize:function(){joint.dia.ElementView.prototype.initialize.apply(this,arguments),"undefined"==typeof SVGForeignObjectElement&&(this.noSVGForeignObjectElement=!0,this.listenTo(this.model,"change:content",function(b){this.updateContent(b)}))},update:function(f,e){if(this.noSVGForeignObjectElement){var i=this.model,h=_.omit(e||i.get("attrs"),".content");joint.dia.ElementView.prototype.update.call(this,i,h),(!e||_.has(e,".content"))&&this.updateContent(i,e)}else{joint.dia.ElementView.prototype.update.call(this,i,e)}},updateContent:function(h,f){var k=_.merge({},(f||h.get("attrs"))[".content"]);delete k.text;var j=joint.util.breakText(h.get("content"),h.get("size"),k,{svgDocument:this.paper.svg}),i=joint.util.setByPath({},".content",k,"/");i[".content"].text=j,joint.dia.ElementView.prototype.update.call(this,h,i)}}),joint.routers.orthogonal=function(){function C(d,c){return d.x==c.x?d.y>c.y?"N":"S":d.y==c.y?d.x>c.x?"W":"E":null}function B(d,c){return d["W"==c||"E"==c?"width":"height"]}function A(d,c){return g.rect(d).moveAndExpand({x:-c,y:-c,width:2*c,height:2*c})}function z(b){return g.rect(b.x,b.y,0,0)}function y(i,h){var m=Math.min(i.x,h.x),l=Math.min(i.y,h.y),k=Math.max(i.x+i.width,h.x+h.width),j=Math.max(i.y+i.height,h.y+h.height);return g.rect(m,l,k-m,j-l)}function x(f,e,i){var h=g.point(f.x,e.y);return i.containsPoint(h)&&(h=g.point(e.x,f.y)),h}function w(G,F,E){var D=g.point(G.x,F.y),o=g.point(F.x,G.y),n=C(G,D),m=C(G,o),l=q[E],a=n==E||n!=l&&(m==l||m!=E)?D:o;return{points:[a],direction:C(a,F)}}function v(a,i,h){var f=x(a,i,h);return{points:[f],direction:C(f,i)}}function u(K,J,I,H){var G,F={},E=[g.point(K.x,J.y),g.point(J.x,K.y)],D=_.filter(E,function(c){return !I.containsPoint(c)}),f=_.filter(D,function(c){return C(c,K)!=H});if(f.length>0){G=_.filter(f,function(c){return C(K,c)==H}).pop(),G=G||f[0],F.points=[G],F.direction=C(G,J)}else{G=_.difference(E,D)[0];var b=g.point(J).move(G,-B(I,H)/2),a=x(b,K,I);F.points=[a,b],F.direction=C(b,J)}return F}function t(K,J,I,H){var G=v(J,K,H),F=G.points[0];if(I.containsPoint(F)){G=v(K,J,I);var E=G.points[0];if(H.containsPoint(E)){var D=g.point(K).move(E,-B(I,C(K,E))/2),i=g.point(J).move(F,-B(H,C(J,F))/2),h=g.line(D,i).midpoint(),b=v(K,h,I),a=w(h,J,b.direction);G.points=[b.points[0],a.points[0]],G.direction=a.direction}}return G}function s(J,I,H,G,F){var E,D,o,f={},e=A(y(H,G),1),c=e.center().distance(I)>e.center().distance(J),a=c?I:J,K=c?J:I;return F?(E=g.point.fromPolar(e.width+e.height,p[F],a),E=e.pointNearestToPoint(E).move(E,-1)):E=e.pointNearestToPoint(a).move(a,1),D=x(E,K,e),E.round().equals(D.round())?(D=g.point.fromPolar(e.width+e.height,g.toRad(E.theta(a))+Math.PI/2,K),D=e.pointNearestToPoint(D).move(K,1).round(),o=x(E,D,e),f.points=c?[D,o,E]:[E,o,D]):f.points=c?[D,E]:[E,D],f.direction=c?C(E,I):C(D,I),f}function r(D,l,k){var j=l.elementPadding||20,i=[],h=A(k.sourceBBox,j),d=A(k.targetBBox,j);D=_.map(D,g.point),D.unshift(h.center()),D.push(d.center());for(var c,a=0,J=D.length-1;J>a;a++){var I=null,H=D[a],G=D[a+1],F=!!C(H,G);if(0==a){a+1==J?h.intersect(A(d,1))?I=s(H,G,h,d):F||(I=t(H,G,h,d)):h.containsPoint(G)?I=s(H,G,h,A(z(G),j)):F||(I=v(H,G,h))}else{if(a+1==J){var E=F&&C(G,H)==c;d.containsPoint(H)||E?I=s(H,G,A(z(H),j),d,c):F||(I=u(H,G,d,c))}else{F||(I=w(H,G,c))}}I?(Array.prototype.push.apply(i,I.points),c=I.direction):c=C(H,G),J>a+1&&i.push(G)}return i}var q={N:"S",S:"N",E:"W",W:"E"},p={N:-Math.PI/2*3,S:-Math.PI/2,E:0,W:Math.PI};return r}(),joint.routers.manhattan=function(){function i(o,n){for(var t,s=[],r={x:0,y:0},q=n;t=o[q];){var p=t.difference(q);p.equals(r)||(s.unshift(q),r=p),q=t}return s.unshift(q),s}function h(o,n,s){var r=s.step,q=o.center(),p=_.chain(s.directionMap).pick(n).map(function(a){var t=a.x*o.width/2,e=a.y*o.height/2,d=g.point(q).offset(t,e).snapToGrid(r);return o.containsPoint(d)&&d.offset(a.x*r,a.y*r),d}).value();return p}function m(n,f,q){var p=360/q,o=Math.floor(n.theta(f)/p);return q-o}function l(aE,aD,aC,aB){var aA=aB.reversed?aB.endDirections:aB.startDirections,az=aB.reversed?aB.startDirections:aB.endDirections,ay=aE instanceof g.rect?h(aE,aA,aB):[aE],ax=aD instanceof g.rect?h(aD,az,aB):[aD],aw=ay.length>1?aE.center():ay[0],av=ax.length>1?aD.center():ax[0],au=_.filter(ax,function(e){var d=g.point(e).snapToGrid(aB.mapGridSize).toString(),f=_.every(aC[d],function(n){return !n.containsPoint(e)});return f});if(au.length){for(var at=aB.step,ar=aB.penalties,aq=_.chain(au).invoke("snapToGrid",at).min(function(d){return aB.estimateCost(aw,d)}).value(),ap={},ao={},an={},am=aB.directions,al=am.length,ak=al/2,aj=aB.previousDirIndexes||{},ai={},ah={},ag=_.chain(ay).invoke("snapToGrid",at).each(function(e){var d=e.toString();ao[d]=0,an[d]=aB.estimateCost(e,aq),aj[d]=aj[d]||m(aw,e,al),ah[d]=!0}).map(function(d){return d.toString()}).sortBy(function(d){return an[d]}).value(),af=aB.maximumLoops,ae=aB.maxAllowedDirectionChange;ag.length&&af--;){var ad=ag[0],ac=g.point(ad);if(aq.equals(ac)){return aB.previousDirIndexes=_.pick(aj,ad),i(ap,ac)}ag.splice(0,1),ah[U]=null,ai[U]=!0;for(var ab=aj[ad],aa=ao[ad],Z=0;al>Z;Z++){var Y=Math.abs(Z-ab);if(Y>ak&&(Y=al-Y),!(Y>ae)){var X=am[Z],W=g.point(ac).offset(X.offsetX,X.offsetY),U=W.toString();if(!ai[U]){var T=g.point(W).snapToGrid(aB.mapGridSize).toString(),S=_.every(aC[T],function(d){return !d.containsPoint(W)});if(S){var c=_.has(ah,U),b=aa+X.cost;if((!c||b<ao[U])&&(ap[U]=ac,aj[U]=Z,ao[U]=b,an[U]=b+aB.estimateCost(W,aq)+ar[Y],!c)){var a=_.sortedIndex(ag,U,function(d){return an[d]});ag.splice(a,0,U),ah[U]=!0}}}}}}}return aB.fallbackRoute(aw,av,aB)}function k(ab,aa){aa.directions=_.result(aa,"directions"),aa.penalties=_.result(aa,"penalties"),aa.paddingBox=_.result(aa,"paddingBox"),this.options.perpendicular=!!aa.perpendicular;var Z=aa.reversed="source"===this.lastEndChange,Y=g.rect(Z?this.targetBBox:this.sourceBBox),X=g.rect(Z?this.sourceBBox:this.targetBBox);Y.moveAndExpand(aa.paddingBox),X.moveAndExpand(aa.paddingBox);var W=this.model,U=this.paper.model,T=_.chain(aa.excludeEnds).map(W.get,W).pluck("id").map(U.getCell,U).value(),S=aa.mapGridSize,R=[],Q=W.get("source").id;if(void 0!==Q){var P=U.getCell(Q);void 0!==P&&(R=_.union(R,_.map(P.getAncestors(),"id")))}var O=W.get("target").id;if(void 0!==O){var N=U.getCell(O);void 0!==N&&(R=_.union(R,_.map(N.getAncestors(),"id")))}for(var L=_.chain(U.getElements()).difference(T).reject(function(b){return _.contains(aa.excludeTypes,b.get("type"))||_.contains(R,b.id)}).invoke("getBBox").invoke("moveAndExpand",aa.paddingBox).foldl(function(o,n){for(var t=n.origin().snapToGrid(S),s=n.corner().snapToGrid(S),r=t.x;r<=s.x;r+=S){for(var q=t.y;q<=s.y;q+=S){var p=r+"@"+q;o[p]=o[p]||[],o[p].push(n)}}return o},{}).value(),J=[],I=_.map(ab,g.point),H=Y.center(),G=0,F=I.length;F>=G;G++){var E=null,D=C||Y,C=I[G];if(!C){C=X;var d=!this.model.get("source").id||!this.model.get("target").id;if(d&&_.isFunction(aa.draggingRoute)){var M=D instanceof g.rect?D.center():D;E=aa.draggingRoute(M,C.origin(),aa)}}E=E||l(D,C,L,aa);var K=_.first(E);K&&K.equals(H)&&E.shift(),H=_.last(E)||H,J=J.concat(E)}return Z?J.reverse():J}var j={step:10,perpendicular:!0,mapGridSize:100,excludeEnds:[],excludeTypes:["basic.Text"],maximumLoops:500,startDirections:["left","right","top","bottom"],endDirections:["left","right","top","bottom"],directionMap:{right:{x:1,y:0},bottom:{x:0,y:1},left:{x:-1,y:0},top:{x:0,y:-1}},maxAllowedDirectionChange:1,paddingBox:function(){var b=this.step;return{x:-b,y:-b,width:2*b,height:2*b}},directions:function(){var b=this.step;return[{offsetX:b,offsetY:0,cost:b},{offsetX:0,offsetY:b,cost:b},{offsetX:-b,offsetY:0,cost:b},{offsetX:0,offsetY:-b,cost:b}]},penalties:function(){return[0,this.step/2,this.step]},estimateCost:function(d,c){return d.manhattanDistance(c)},fallbackRoute:function(n,f,q){var p=q.prevDirIndexes||{},o=(p[n]||0)%2?g.point(n.x,f.y):g.point(f.x,n.y);return[o,f]},draggingRoute:null};return function(e,d,f){return k.call(f,e,_.extend({},j,d))}}(),joint.routers.metro=function(){if(!_.isFunction(joint.routers.manhattan)){throw"Metro requires the manhattan router."}var b={diagonalCost:null,directions:function(){var d=this.step,c=this.diagonalCost||Math.ceil(Math.sqrt(d*d<<1));return[{offsetX:d,offsetY:0,cost:d},{offsetX:d,offsetY:d,cost:c},{offsetX:0,offsetY:d,cost:d},{offsetX:-d,offsetY:d,cost:c},{offsetX:-d,offsetY:0,cost:d},{offsetX:-d,offsetY:-d,cost:c},{offsetX:0,offsetY:-d,cost:d},{offsetX:d,offsetY:-d,cost:c}]},fallbackRoute:function(A,z,y){var x=A.theta(z),w={x:z.x,y:A.y},v={x:A.x,y:z.y};if(x%180>90){var u=w;w=v,v=u}var t=45>x%90?w:v,s=g.line(A,t),r=90*Math.ceil(x/90),q=g.point.fromPolar(s.squaredLength(),g.toRad(r+135),t),p=g.line(z,q),o=s.intersection(p);return o?[o.round(),z]:[z]}};return function(a,f,e){return joint.routers.manhattan(a,_.extend({},b,f),e)}}(),joint.connectors.normal=function(f,e,i){var h=["M",f.x,f.y];return _.each(i,function(b){h.push(b.x,b.y)}),h.push(e.x,e.y),h.join(" ")},joint.connectors.rounded=function(y,x,w,v){var u,t,s,r,q,p,o=v.radius||10,n=["M",y.x,y.y];return _.each(w,function(a,b){q=w[b-1]||y,p=w[b+1]||x,s=r||g.point(a).distance(q)/2,r=g.point(a).distance(p)/2,u=g.point(a).move(q,-Math.min(o,s)).round(),t=g.point(a).move(p,-Math.min(o,r)).round(),n.push(u.x,u.y,"S",a.x,a.y,t.x,t.y,"L")}),n.push(x.x,x.y),n.join(" ")},joint.connectors.smooth=function(h,f,k){var j;if(k.length){j=g.bezier.curveThroughPoints([h].concat(k).concat([f]))}else{var i=h.x<f.x?f.x-(f.x-h.x)/2:h.x-(h.x-f.x)/2;j=["M",h.x,h.y,"C",i,h.y,i,f.y,f.x,f.y]}return j.join(" ")};