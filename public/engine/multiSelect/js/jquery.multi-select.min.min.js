!function(c){var d=function(a,b){this.options=b;this.$element=c(a);this.$container=c("<div/>",{"class":"ms-container"});this.$selectableContainer=c("<div/>",{"class":"ms-selectable"});this.$selectionContainer=c("<div/>",{"class":"ms-selection"});this.$selectableUl=c("<ul/>",{"class":"ms-list",tabindex:"-1"});this.$selectionUl=c("<ul/>",{"class":"ms-list",tabindex:"-1"});this.scrollTo=0;this.elemsSelector="li:visible:not(.ms-optgroup-label,.ms-optgroup-container,."+b.disabledClass+")"};d.prototype={constructor:d,init:function(){var b=this,g=this.$element;if(g.next(".ms-container").length===0){g.css({position:"absolute",left:"-9999px"});g.attr("id",g.attr("id")?g.attr("id"):Math.ceil(Math.random()*1000)+"multiselect");this.$container.attr("id","ms-"+g.attr("id"));this.$container.addClass(b.options.cssClass);g.find("option").each(function(){b.generateLisFromOption(this)});this.$selectionUl.find(".ms-optgroup-label").hide();if(b.options.selectableHeader){b.$selectableContainer.append(b.options.selectableHeader)}b.$selectableContainer.append(b.$selectableUl);if(b.options.selectableFooter){b.$selectableContainer.append(b.options.selectableFooter)}if(b.options.selectionHeader){b.$selectionContainer.append(b.options.selectionHeader)}b.$selectionContainer.append(b.$selectionUl);if(b.options.selectionFooter){b.$selectionContainer.append(b.options.selectionFooter)}b.$container.append(b.$selectableContainer);b.$container.append(b.$selectionContainer);g.after(b.$container);b.activeMouse(b.$selectableUl);b.activeKeyboard(b.$selectableUl);var a=b.options.dblClick?"dblclick":"click";b.$selectableUl.on(a,".ms-elem-selectable",function(){b.select(c(this).data("ms-value"))});b.$selectionUl.on(a,".ms-elem-selection",function(){b.deselect(c(this).data("ms-value"))});b.activeMouse(b.$selectionUl);b.activeKeyboard(b.$selectionUl);g.on("focus",function(){b.$selectableUl.focus()})}var h=g.find("option:selected").map(function(){return c(this).val()}).get();b.select(h,"init");if(typeof b.options.afterInit==="function"){b.options.afterInit.call(this,this.$container)}},generateLisFromOption:function(F,L,z){var J=this,D=J.$element,I="",A=c(F);for(var H=0;H<F.attributes.length;H++){var B=F.attributes[H];if(B.name!=="value"&&B.name!=="disabled"){I+=B.name+'="'+B.value+'" '}}var x=c("<li "+I+"><span>"+J.escapeHTML(A.text())+"</span></li>"),M=x.clone(),C=A.val(),G=J.sanitize(C);x.data("ms-value",C).addClass("ms-elem-selectable").attr("id",G+"-selectable");M.data("ms-value",C).addClass("ms-elem-selection").attr("id",G+"-selection").hide();if(A.prop("disabled")||D.prop("disabled")){M.addClass(J.options.disabledClass);x.addClass(J.options.disabledClass)}var E=A.parent("optgroup");if(E.length>0){var K=E.attr("label"),N=J.sanitize(K),a=J.$selectableUl.find("#optgroup-selectable-"+N),w=J.$selectionUl.find("#optgroup-selection-"+N);if(a.length===0){var b='<li class="ms-optgroup-container"></li>',y='<ul class="ms-optgroup"><li class="ms-optgroup-label"><span>'+K+"</span></li></ul>";a=c(b);w=c(b);a.attr("id","optgroup-selectable-"+N);w.attr("id","optgroup-selection-"+N);a.append(c(y));w.append(c(y));if(J.options.selectableOptgroup){a.find(".ms-optgroup-label").on("click",function(){var e=E.children(":not(:selected, :disabled)").map(function(){return c(this).val()}).get();J.select(e)});w.find(".ms-optgroup-label").on("click",function(){var e=E.children(":selected:not(:disabled)").map(function(){return c(this).val()}).get();J.deselect(e)})}J.$selectableUl.append(a);J.$selectionUl.append(w)}L=L==undefined?a.find("ul").children().length:L+1;x.insertAt(L,a.children());M.insertAt(L,w.children())}else{L=L==undefined?J.$selectableUl.children().length:L;x.insertAt(L,J.$selectableUl);M.insertAt(L,J.$selectionUl)}},addOption:function(b){var a=this;if(b.value!==undefined&&b.value!==null){b=[b]}c.each(b,function(l,k){if(k.value!==undefined&&k.value!==null&&a.$element.find("option[value='"+k.value+"']").length===0){var j=c('<option value="'+k.value+'">'+k.text+"</option>"),l=parseInt((typeof k.index==="undefined"?a.$element.children().length:k.index)),i=k.nested==undefined?a.$element:c("optgroup[label='"+k.nested+"']");j.insertAt(l,i);a.generateLisFromOption(j.get(0),l,k.nested)}})},escapeHTML:function(a){return c("<div>").text(a).html()},activeKeyboard:function(b){var a=this;b.on("focus",function(){c(this).addClass("ms-focus")}).on("blur",function(){c(this).removeClass("ms-focus")}).on("keydown",function(e){switch(e.which){case 40:case 38:e.preventDefault();e.stopPropagation();a.moveHighlight(c(this),(e.which===38)?-1:1);return;case 37:case 39:e.preventDefault();e.stopPropagation();a.switchList(b);return;case 9:if(a.$element.is("[tabindex]")){e.preventDefault();var h=parseInt(a.$element.attr("tabindex"),10);h=(e.shiftKey)?h-1:h+1;c('[tabindex="'+(h)+'"]').focus();return}else{if(e.shiftKey){a.$element.trigger("focus")}}}if(c.inArray(e.which,a.options.keySelect)>-1){e.preventDefault();e.stopPropagation();a.selectHighlighted(b);return}})},moveHighlight:function(x,r){var z=x.find(this.elemsSelector),q=z.filter(".ms-hover"),b=null,y=z.first().outerHeight(),a=x.height(),v="#"+this.$container.prop("id");z.removeClass("ms-hover");if(r===1){b=q.nextAll(this.elemsSelector).first();if(b.length===0){var w=q.parent();if(w.hasClass("ms-optgroup")){var s=w.parent(),p=s.next(":visible");if(p.length>0){b=p.find(this.elemsSelector).first()}else{b=z.first()}}else{b=z.first()}}}else{if(r===-1){b=q.prevAll(this.elemsSelector).first();if(b.length===0){var w=q.parent();if(w.hasClass("ms-optgroup")){var s=w.parent(),t=s.prev(":visible");if(t.length>0){b=t.find(this.elemsSelector).last()}else{b=z.last()}}else{b=z.last()}}}}if(b.length>0){b.addClass("ms-hover");var u=x.scrollTop()+b.position().top-a/2+y/2;x.scrollTop(u)}},selectHighlighted:function(f){var a=f.find(this.elemsSelector),b=a.filter(".ms-hover").first();if(b.length>0){if(f.parent().hasClass("ms-selectable")){this.select(b.data("ms-value"))}else{this.deselect(b.data("ms-value"))}a.removeClass("ms-hover")}},switchList:function(a){a.blur();this.$container.find(this.elemsSelector).removeClass("ms-hover");if(a.parent().hasClass("ms-selectable")){this.$selectionUl.focus()}else{this.$selectableUl.focus()}},activeMouse:function(b){var a=this;c("body").on("mouseenter",a.elemsSelector,function(){c(this).parents(".ms-container").find(a.elemsSelector).removeClass("ms-hover");c(this).addClass("ms-hover")});c("body").on("mouseleave",a.elemsSelector,function(){c(this).parents(".ms-container").find(a.elemsSelector).removeClass("ms-hover")})},refresh:function(){this.destroy();this.$element.multiSelect(this.options)},destroy:function(){c("#ms-"+this.$element.attr("id")).remove();this.$element.css("position","").css("left","");this.$element.removeData("multiselect")},select:function(b,v){if(typeof b==="string"){b=[b]}var r=this,u=this.$element,q=c.map(b,function(e){return(r.sanitize(e))}),p=this.$selectableUl.find("#"+q.join("-selectable, #")+"-selectable").filter(":not(."+r.options.disabledClass+")"),t=this.$selectionUl.find("#"+q.join("-selection, #")+"-selection").filter(":not(."+r.options.disabledClass+")"),a=u.find("option:not(:disabled)").filter(function(){return(c.inArray(this.value,b)>-1)});if(v==="init"){p=this.$selectableUl.find("#"+q.join("-selectable, #")+"-selectable"),t=this.$selectionUl.find("#"+q.join("-selection, #")+"-selection")}if(p.length>0){p.addClass("ms-selected").hide();t.addClass("ms-selected").show();a.prop("selected",true);r.$container.find(r.elemsSelector).removeClass("ms-hover");var n=r.$selectableUl.children(".ms-optgroup-container");if(n.length>0){n.each(function(){var e=c(this).find(".ms-elem-selectable");if(e.length===e.filter(".ms-selected").length){c(this).find(".ms-optgroup-label").hide()}});var o=r.$selectionUl.children(".ms-optgroup-container");o.each(function(){var e=c(this).find(".ms-elem-selection");if(e.filter(".ms-selected").length>0){c(this).find(".ms-optgroup-label").show()}})}else{if(r.options.keepOrder&&v!=="init"){var s=r.$selectionUl.find(".ms-selected");if((s.length>1)&&(s.last().get(0)!=t.get(0))){t.insertAfter(s.last())}}}if(v!=="init"){u.trigger("change");if(typeof r.options.afterSelect==="function"){r.options.afterSelect.call(this,b)}}}},deselect:function(b){if(typeof b==="string"){b=[b]}var p=this,r=this.$element,o=c.map(b,function(e){return(p.sanitize(e))}),n=this.$selectableUl.find("#"+o.join("-selectable, #")+"-selectable"),q=this.$selectionUl.find("#"+o.join("-selection, #")+"-selection").filter(".ms-selected").filter(":not(."+p.options.disabledClass+")"),a=r.find("option").filter(function(){return(c.inArray(this.value,b)>-1)});if(q.length>0){n.removeClass("ms-selected").show();q.removeClass("ms-selected").hide();a.prop("selected",false);p.$container.find(p.elemsSelector).removeClass("ms-hover");var l=p.$selectableUl.children(".ms-optgroup-container");if(l.length>0){l.each(function(){var e=c(this).find(".ms-elem-selectable");if(e.filter(":not(.ms-selected)").length>0){c(this).find(".ms-optgroup-label").show()}});var m=p.$selectionUl.children(".ms-optgroup-container");m.each(function(){var e=c(this).find(".ms-elem-selection");if(e.filter(".ms-selected").length===0){c(this).find(".ms-optgroup-label").hide()}})}r.trigger("change");if(typeof p.options.afterDeselect==="function"){p.options.afterDeselect.call(this,b)}}},select_all:function(){var a=this.$element,b=a.val();a.find('option:not(":disabled")').prop("selected",true);this.$selectableUl.find(".ms-elem-selectable").filter(":not(."+this.options.disabledClass+")").addClass("ms-selected").hide();this.$selectionUl.find(".ms-optgroup-label").show();this.$selectableUl.find(".ms-optgroup-label").hide();this.$selectionUl.find(".ms-elem-selection").filter(":not(."+this.options.disabledClass+")").addClass("ms-selected").show();this.$selectionUl.focus();a.trigger("change");if(typeof this.options.afterSelect==="function"){var f=c.grep(a.val(),function(e){return c.inArray(e,b)<0});this.options.afterSelect.call(this,f)}},deselect_all:function(){var a=this.$element,b=a.val();a.find("option").prop("selected",false);this.$selectableUl.find(".ms-elem-selectable").removeClass("ms-selected").show();this.$selectionUl.find(".ms-optgroup-label").hide();this.$selectableUl.find(".ms-optgroup-label").show();this.$selectionUl.find(".ms-elem-selection").removeClass("ms-selected").hide();this.$selectableUl.focus();a.trigger("change");if(typeof this.options.afterDeselect==="function"){this.options.afterDeselect.call(this,b)}},sanitize:function(b){var a=0,i,h;if(b.length==0){return a}var j=0;for(i=0,j=b.length;i<j;i++){h=b.charCodeAt(i);a=((a<<5)-a)+h;a|=0}return a}};c.fn.multiSelect=function(){var a=arguments[0],b=arguments;return this.each(function(){var h=c(this),i=h.data("multiselect"),j=c.extend({},c.fn.multiSelect.defaults,h.data(),typeof a==="object"&&a);if(!i){h.data("multiselect",(i=new d(this,j)))}if(typeof a==="string"){i[a](b[1])}else{i.init()}})};c.fn.multiSelect.defaults={keySelect:[32],selectableOptgroup:false,disabledClass:"disabled",dblClick:false,keepOrder:false,cssClass:""};c.fn.multiSelect.Constructor=d;c.fn.insertAt=function(b,a){return this.each(function(){if(b===0){a.prepend(this)}else{a.children().eq(b-1).after(this)}})}}(window.jQuery);